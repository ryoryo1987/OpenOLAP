--create function plpgsql_call_handler()
--	returns opaque
--	as '/usr/local/pgsql/lib/plpgsql.so'
--	LANGUAGE 'C';
/

--create language 'plpgsql' handler plpgsql_call_handler
--	lancompiler 'PL/pgSQL';
/

CREATE FUNCTION %schema%.oo_add_months(date, integer) RETURNS date AS '
SELECT ($1 + ( $2::text || '' months'')::interval)::date;
' LANGUAGE 'sql';
/

CREATE FUNCTION %schema%.oo_current_date() RETURNS date AS '
	select current_date
' LANGUAGE 'sql';
/

CREATE FUNCTION %schema%.oo_current_mc() RETURNS integer AS '
	select cast(to_char(oo_current_date(),''YYYYMMDD'') || ''7'' as integer)
' LANGUAGE 'sql';
/


CREATE FUNCTION %schema%.oo_CREATE_META_TIME(DATE,DATE) RETURNS INTEGER AS '
DECLARE

    START_DAY    ALIAS FOR $1;
    END_DAY    ALIAS FOR $2;

    YEAR_MC           INTEGER;
    HALF_MC           INTEGER;
    QUARTER_MC        INTEGER;
    MONTH_MC          INTEGER;
    DAY_MC            INTEGER;

    preYEAR_MC        INTEGER;
    preHALF_MC        INTEGER;
    preQUARTER_MC     INTEGER;
    preMONTH_MC       INTEGER;

    YEAR_DATE         DATE;
    HALF_DATE         DATE;
    QUARTER_DATE      DATE;
    MONTH_DATE        DATE;
    DAY_DATE          DATE;

    CUR_DATE         DATE;

BEGIN
preYEAR_MC   :=0;
preHALF_MC   :=0;
preQUARTER_MC:=0;
preMONTH_MC  :=0;

    CUR_DATE := START_DAY;
    LOOP

        YEAR_MC := TO_CHAR(CUR_DATE,''YYYY0000'') || ''1'';
        YEAR_DATE := DATE_TRUNC(''year'',CUR_DATE);


        IF TO_CHAR(CUR_DATE,''MM'') IN (''01'',''02'',''03'',''04'',''05'',''06'') THEN
            HALF_MC := TO_CHAR(CUR_DATE,''YYYY1000'') || ''2'';
            HALF_DATE := TO_DATE(TO_CHAR(CUR_DATE,''YYYY'')||''0101'',''YYYYMMDD'');
        ELSE
            HALF_MC := TO_CHAR(CUR_DATE,''YYYY2000'') || ''2'';
            HALF_DATE := TO_DATE(TO_CHAR(CUR_DATE,''YYYY'')||''0701'',''YYYYMMDD'');
        END IF; 

        IF TO_CHAR(CUR_DATE,''MM'') IN (''01'',''02'',''03'') THEN
            QUARTER_MC := TO_CHAR(CUR_DATE,''YYYY1000'') || ''3'';
            QUARTER_DATE := DATE_TRUNC(''quarter'',CUR_DATE);
        ELSIF TO_CHAR(CUR_DATE,''MM'') IN (''04'',''05'',''06'') THEN
            QUARTER_MC := TO_CHAR(CUR_DATE,''YYYY2000'') || ''3'';
            QUARTER_DATE := DATE_TRUNC(''quarter'',CUR_DATE);
        ELSIF TO_CHAR(CUR_DATE,''MM'') IN (''07'',''08'',''09'') THEN
            QUARTER_MC := TO_CHAR(CUR_DATE,''YYYY3000'') || ''3'';
            QUARTER_DATE := DATE_TRUNC(''quarter'',CUR_DATE);
        ELSIF TO_CHAR(CUR_DATE,''MM'') IN (''10'',''11'',''12'') THEN
            QUARTER_MC := TO_CHAR(CUR_DATE,''YYYY4000'') || ''3'';
            QUARTER_DATE := DATE_TRUNC(''quarter'',CUR_DATE);
        END IF;

        MONTH_MC := TO_CHAR(CUR_DATE,''YYYY'') || TO_CHAR(CUR_DATE,''MM'') || ''004'';
        MONTH_DATE := DATE_TRUNC(''month'',CUR_DATE);

        DAY_MC := TO_CHAR(CUR_DATE,''YYYYMMDD'') || ''7'';
        DAY_DATE := CUR_DATE;

        IF YEAR_MC!=preYEAR_MC THEN
            INSERT INTO oo_YEAR VALUES(YEAR_MC,YEAR_DATE);
            preYEAR_MC:=YEAR_MC;
        END IF;

        IF HALF_MC!=preHALF_MC THEN
            INSERT INTO oo_HALF VALUES(HALF_MC,YEAR_MC,HALF_DATE);
            preHALF_MC:=HALF_MC;
        END IF;

        IF QUARTER_MC!=preQUARTER_MC THEN
            INSERT INTO oo_QUARTER VALUES(QUARTER_MC,YEAR_MC,HALF_MC,QUARTER_DATE);
            preQUARTER_MC:=QUARTER_MC;
        END IF;

        IF MONTH_MC!=preMONTH_MC THEN
            INSERT INTO oo_MONTH VALUES(MONTH_MC,MONTH_DATE);
            preMONTH_MC:=MONTH_MC;
        END IF;

        INSERT INTO oo_DAY VALUES(DAY_MC,DAY_DATE,''0'');

        CUR_DATE := CUR_DATE + 1; 

        IF CUR_DATE = END_DAY THEN
            EXIT;
        END IF;

    END LOOP;

	return 1;

END;
'LANGUAGE 'plpgsql';
/


CREATE FUNCTION %schema%.oo_fun_month(integer,varchar(10),char(2)) RETURNS integer AS '
DECLARE
	vMONTH_MC			ALIAS FOR $1;
	vPARENT_COLUMN		ALIAS FOR $2;
	vSTART_MONTH			ALIAS FOR $3;

	YEAR_YYYY CHAR(4);
	vPARENT_ID integer;

BEGIN
	IF SUBSTR(vMONTH_MC,5,2) < vSTART_MONTH THEN
		YEAR_YYYY := to_number(SUBSTR(vMONTH_MC,1,4),9999) -1;
	ELSE
		YEAR_YYYY := SUBSTR(vMONTH_MC,1,4);
	END IF;


	IF vPARENT_COLUMN = ''YEAR_MC'' THEN
			vPARENT_ID := YEAR_YYYY || ''00001'';
	END IF;

	IF vPARENT_COLUMN = ''HALF_MC'' THEN
		IF SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),0),''MM'') AND SUBSTR(vMONTH_MC,5,4) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''10002'';
		ELSIF  SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') AND SUBSTR(vMONTH_MC,5,4) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),12),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''20002'';
		ELSE
			IF TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),0),''MM'')>TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') THEN
				vPARENT_ID := YEAR_YYYY || ''10002'';
			ELSE
				vPARENT_ID := YEAR_YYYY || ''20002'';
			END IF;
		END IF;
	END IF;

	IF vPARENT_COLUMN = ''QUARTER_MC'' THEN
		IF SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),0),''MM'') AND SUBSTR(vMONTH_MC,5,2) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),3),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''10003'';
		ELSIF  SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),3),''MM'') AND SUBSTR(vMONTH_MC,5,2) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''20003'';
		ELSIF  SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') AND SUBSTR(vMONTH_MC,5,2) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),9),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''30003'';
		ELSIF  SUBSTR(vMONTH_MC,5,2) >= TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),9),''MM'') AND SUBSTR(vMONTH_MC,5,2) < TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),12),''MM'') THEN
			vPARENT_ID := YEAR_YYYY || ''40003'';
		ELSE
			IF TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),0),''MM'')>TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),3),''MM'') THEN
				vPARENT_ID := YEAR_YYYY || ''10003'';
			ELSIF TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),3),''MM'')>TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'') THEN
				vPARENT_ID := YEAR_YYYY || ''20003'';
			ELSIF TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),6),''MM'')>TO_CHAR(oo_add_months(TO_DATE(vSTART_MONTH,''MM''),9),''MM'') THEN
				vPARENT_ID := YEAR_YYYY || ''30003'';
			ELSE
				vPARENT_ID := YEAR_YYYY || ''40003'';
			END IF;
		END IF;

	END IF;

	IF vPARENT_COLUMN = ''0'' THEN
		vPARENT_ID := ''0'';
	END IF;

	IF vPARENT_COLUMN is null THEN
		vPARENT_ID := null;
	END IF;
	return vPARENT_ID;

END;
'LANGUAGE 'plpgsql';
/


CREATE FUNCTION %schema%.oo_fun_day(integer,varchar(10),char(2)) RETURNS integer AS '
DECLARE

	vDAY_MC				ALIAS FOR $1;
	vPARENT_COLUMN		ALIAS FOR $2;
	vSTART_MONTH		ALIAS FOR $3;

	YEAR_YYYY CHAR(4);
	vPARENT_ID integer;

BEGIN
	IF vPARENT_COLUMN = ''YEAR_MC'' or vPARENT_COLUMN = ''HALF_MC'' or vPARENT_COLUMN = ''QUARTER_MC'' THEN
			select into vPARENT_ID oo_fun_month(vDAY_MC,vPARENT_COLUMN,vSTART_MONTH);
	END IF;

	IF vPARENT_COLUMN = ''MONTH_MC'' THEN
		vPARENT_ID := substr(vDAY_MC,1,6) || ''004'';
	END IF;

	IF vPARENT_COLUMN = ''0'' THEN
		vPARENT_ID := ''0'';
	END IF;

	return vPARENT_ID;
END;
'LANGUAGE 'plpgsql';
/

CREATE FUNCTION %schema%.oo_fun_week(integer,varchar(10),char(2),char(1)) RETURNS integer AS '
DECLARE
	vDAY_MC				ALIAS FOR $1;
	vPARENT_COLUMN		ALIAS FOR $2;
	vSTART_MONTH		ALIAS FOR $3;
	vWEEK_KIND_FLG		ALIAS FOR $4;

	vYYYY_DAY				char(4);
	vMM_DAY					char(2);
	vDD_DAY					char(2);
	vYYYYMMDD_DAY			char(8);
	vMMDD_DAY				char(4);
	vDATE_DAY				date;

	vMMDD_START_DAY    		char(4);
	vYYYYMMDD_START_DAY		char(8);
	vDATE_START_DAY			date;
	START_DAY_OF_THE_WEEK	char(1);

	DIF_DAY					integer;
	FIRST_DAY_COUNT			integer;

	WEEK_START_YOBI			char(1);

	WEEK_DATA				integer;

	YEAR_YYYY CHAR(4);
	vPARENT_ID integer;

	WEEK_COUNT numeric(2);

BEGIN
WEEK_START_YOBI:=''1'';

	vYYYY_DAY    :=substr(vDAY_MC,1,4);
	vMM_DAY      :=substr(vDAY_MC,5,2);
	vDD_DAY      :=substr(vDAY_MC,7,2);
	vMMDD_DAY    :=vMM_DAY || vDD_DAY;
	vYYYYMMDD_DAY:=vYYYY_DAY || vMMDD_DAY;
	vDATE_DAY    :=to_date(vYYYYMMDD_DAY,''YYYYMMDD'');

	vMMDD_START_DAY :=vSTART_MONTH || ''01'';

IF vWEEK_KIND_FLG = ''Y'' THEN
	IF vMMDD_DAY >= vMMDD_START_DAY THEN
		vYYYYMMDD_START_DAY   :=substr(vDAY_MC,1,4) || vSTART_MONTH || ''01'';
	ELSE
		vYYYYMMDD_START_DAY   :=to_number(substr(vDAY_MC,1,4),''9999'')-1 || vSTART_MONTH || ''01'';
	END IF;
ELSIF vWEEK_KIND_FLG = ''M'' THEN
	vYYYYMMDD_START_DAY   :=vYYYY_DAY || vMM_DAY || ''01'';
END IF;

	vDATE_START_DAY   :=to_date(vYYYYMMDD_START_DAY,''YYYYMMDD'');
	START_DAY_OF_THE_WEEK :=TO_CHAR(vDATE_START_DAY,''D'');
	DIF_DAY:=ABS(vDATE_START_DAY-vDATE_DAY);

	DIF_DAY:=DIF_DAY+1;

	IF WEEK_START_YOBI <= START_DAY_OF_THE_WEEK THEN
		FIRST_DAY_COUNT := 7 + to_number(WEEK_START_YOBI,''9'') - to_number(START_DAY_OF_THE_WEEK,''9'');
	ELSE
		FIRST_DAY_COUNT := to_number(WEEK_START_YOBI,''9'') - to_number(START_DAY_OF_THE_WEEK,''9'');
	END IF;

	IF DIF_DAY <= FIRST_DAY_COUNT THEN
		WEEK_COUNT := 1;
	ELSE
		if mod(DIF_DAY - FIRST_DAY_COUNT,  7) = 0 then
			WEEK_COUNT := to_number((DIF_DAY - FIRST_DAY_COUNT) / 7,''99'') + 1;
		else
			WEEK_COUNT := to_number((DIF_DAY - FIRST_DAY_COUNT) / 7,''99'') + 2;
		end if;
	END IF;

	IF vWEEK_KIND_FLG = ''Y'' THEN
		IF WEEK_COUNT < 10 THEN
			WEEK_DATA:=SUBSTR(oo_FUN_DAY(vDAY_MC,''YEAR_MC'',vSTART_MONTH),1,4) || ''0'' || WEEK_COUNT || ''006'';
		ELSE
			WEEK_DATA:=SUBSTR(oo_FUN_DAY(vDAY_MC,''YEAR_MC'',vSTART_MONTH),1,4) || WEEK_COUNT || ''006'';
		END IF;
	ELSIF vWEEK_KIND_FLG = ''M'' THEN
		WEEK_DATA:=SUBSTR(oo_FUN_DAY(vDAY_MC,''MONTH_MC'',vSTART_MONTH),1,6) || WEEK_COUNT || ''05'';
	END IF;

return WEEK_DATA;
END;
'LANGUAGE 'plpgsql';
/

CREATE FUNCTION %schema%.oo_fun_week_date(integer,varchar(10),char(2),char(1)) RETURNS date AS '
DECLARE
	vDAY_MC				ALIAS FOR $1;
	vPARENT_COLUMN		ALIAS FOR $2;
	vSTART_MONTH		ALIAS FOR $3;
	vWEEK_KIND_FLG		ALIAS FOR $4;

	vYYYY_DAY				char(4);
	vMM_DAY					char(2);
	vDD_DAY					char(2);
	vYYYYMMDD_DAY			char(8);
	vMMDD_DAY				char(4);
	vDATE_DAY				date;

	vMMDD_START_DAY    		char(4);
	vYYYYMMDD_START_DAY		char(8);
	vDATE_START_DAY			date;
	START_DAY_OF_THE_WEEK	char(1);

	DIF_DAY					integer;
	FIRST_DAY_COUNT			integer;

	WEEK_START_YOBI			char(1);

	WEEK_DATA				date;

	YEAR_YYYY CHAR(4);
	vPARENT_ID integer;

	WEEK_COUNT numeric(2);

BEGIN
WEEK_START_YOBI:=''1'';

	vYYYY_DAY    :=substr(vDAY_MC,1,4);
	vMM_DAY      :=substr(vDAY_MC,5,2);
	vDD_DAY      :=substr(vDAY_MC,7,2);
	vMMDD_DAY    :=vMM_DAY || vDD_DAY;
	vYYYYMMDD_DAY:=vYYYY_DAY || vMMDD_DAY;
	vDATE_DAY    :=to_date(vYYYYMMDD_DAY,''YYYYMMDD'');

	vMMDD_START_DAY :=vSTART_MONTH || ''01'';

IF vWEEK_KIND_FLG = ''Y'' THEN
	IF vMMDD_DAY >= vMMDD_START_DAY THEN
		vYYYYMMDD_START_DAY   :=substr(vDAY_MC,1,4) || vSTART_MONTH || ''01'';
	ELSE
		vYYYYMMDD_START_DAY   :=to_number(substr(vDAY_MC,1,4),''9999'')-1 || vSTART_MONTH || ''01'';
	END IF;
ELSIF vWEEK_KIND_FLG = ''M'' THEN
	vYYYYMMDD_START_DAY   :=vYYYY_DAY || vMM_DAY || ''01'';
END IF;

	vDATE_START_DAY   :=to_date(vYYYYMMDD_START_DAY,''YYYYMMDD'');
	START_DAY_OF_THE_WEEK :=TO_CHAR(vDATE_START_DAY,''D'');
	DIF_DAY:=ABS(vDATE_START_DAY-vDATE_DAY);

	DIF_DAY:=DIF_DAY+1;

	IF WEEK_START_YOBI <= START_DAY_OF_THE_WEEK THEN
		FIRST_DAY_COUNT := 7 + to_number(WEEK_START_YOBI,''9'') - to_number(START_DAY_OF_THE_WEEK,''9'');
	ELSE
		FIRST_DAY_COUNT := to_number(WEEK_START_YOBI,''9'') - to_number(START_DAY_OF_THE_WEEK,''9'');
	END IF;

	IF DIF_DAY <= FIRST_DAY_COUNT THEN
		WEEK_DATA := vDATE_START_DAY;
	ELSE
		if mod(DIF_DAY - FIRST_DAY_COUNT,  7) = 0 then
			WEEK_DATA := vDATE_DAY -6;
		else
			WEEK_DATA := vDATE_DAY - mod(DIF_DAY - FIRST_DAY_COUNT,7) + 1;
		end if;
	END IF;

return WEEK_DATA;
END;
'LANGUAGE 'plpgsql';
/

create function %schema%.oo_create_time_dim(integer) returns text as '
DECLARE

 TIME_ID            ALIAS FOR $1;
 SQL_STAT         VARCHAR(2000);

 LEVEL_COUNTER   numeric(2);
 PARENT_COLUMN    VARCHAR(30);

 vNAME                varchar(50);
 vSTART_MONTH         varchar(2);
 vTOTAL_FLG            VARCHAR(1);
 vYEAR_FLG            VARCHAR(1);
 vYEAR_L_CODE      VARCHAR(2);
 vYEAR_S_CODE      VARCHAR(2);
 vYEAR_L_NAME      VARCHAR(256);
 vYEAR_S_NAME      VARCHAR(256);
 vHALF_FLG            VARCHAR(1);
 vHALF_L_CODE      VARCHAR(2);
 vHALF_S_CODE      VARCHAR(2);
 vHALF_L_NAME      VARCHAR(256);
 vHALF_S_NAME     VARCHAR(256);
 vQUARTER_FLG          VARCHAR(1);
 vQUARTER_L_CODE      VARCHAR(2);
 vQUARTER_S_CODE      VARCHAR(2);
 vQUARTER_L_NAME    VARCHAR(256);
 vQUARTER_S_NAME    VARCHAR(256);
 vMONTH_FLG           VARCHAR(1);
 vMONTH_L_CODE      VARCHAR(2);
 vMONTH_S_CODE      VARCHAR(2);
 vMONTH_L_NAME     VARCHAR(256);
 vMONTH_S_NAME    VARCHAR(256);
 vWEEK_FLG            VARCHAR(1);
 vWEEK_KIND_FLG       varchar(1);
 vWEEK_L_CODE      VARCHAR(2);
 vWEEK_S_CODE      VARCHAR(2);
 vWEEK_L_NAME      VARCHAR(256);
 vWEEK_S_NAME     VARCHAR(256);
 vDAY_FLG             VARCHAR(1);
 vDAY_L_CODE      VARCHAR(2);
 vDAY_S_CODE      VARCHAR(2);
 vDAY_L_NAME       VARCHAR(256);
 vDAY_S_NAME      VARCHAR(256);
 vTIME_FUTURE_SPAN1      numeric(4);
 vTIME_PAST_SPAN1        numeric(4);
 vTIME_LENGTH1           numeric(2);

 vTIME_LEN_COL        VARCHAR(30);
 rec 					record;
 vKONKI_START_DATE		date;
 vKONKI_END_DATE  		date;

BEGIN

SELECT 
INTO 
 vNAME            ,
 vSTART_MONTH     ,
 vYEAR_FLG        ,
 vYEAR_L_CODE  ,
 vYEAR_S_CODE ,
 vHALF_FLG        ,
 vHALF_L_CODE  ,
 vHALF_S_CODE ,
 vQUARTER_FLG      ,
 vQUARTER_L_CODE,
 vQUARTER_S_CODE,
 vMONTH_FLG       ,
 vMONTH_L_CODE ,
 vMONTH_S_CODE,
 vWEEK_FLG        ,
 vWEEK_KIND_FLG   ,
 vWEEK_L_CODE  ,
 vWEEK_S_CODE ,
 vDAY_FLG         ,
 vDAY_L_CODE   ,
 vDAY_S_CODE  ,
 vTIME_FUTURE_SPAN1,
 vTIME_PAST_SPAN1  ,
 vTIME_LENGTH1     ,
 vTOTAL_FLG
        NAME                   ,
        START_MONTH            ,
        YEAR_FLG               ,
        YEAR_LONG_NAME         ,
        YEAR_SHORT_NAME        ,
        HALF_FLG               ,
        HALF_LONG_NAME         ,
        HALF_SHORT_NAME        ,
        QUARTER_FLG             ,
        QUARTER_LONG_NAME       ,
        QUARTER_SHORT_NAME      ,
        MONTH_FLG              ,
        MONTH_LONG_NAME        ,
        MONTH_SHORT_NAME       ,
        WEEK_FLG               ,
        WEEK_KIND_FLG          ,
        WEEK_LONG_NAME         ,
        WEEK_SHORT_NAME        ,
        DAY_FLG                ,
        DAY_LONG_NAME          ,
        DAY_SHORT_NAME         ,
        TIME_FUTURE_SPAN      ,
        TIME_PAST_SPAN        ,
        TIME_LENGTH           ,
        TOTAL_FLG
FROM %schema%.oo_TIME WHERE TIME_SEQ = TIME_ID;

LEVEL_COUNTER:=1;

PARENT_COLUMN:=''null'';

IF vTIME_LENGTH1=12 THEN
    vTIME_LEN_COL:=''YEAR_MC'';
ELSIF vTIME_LENGTH1=6 THEN
    vTIME_LEN_COL:=''HALF_MC'';
ELSIF vTIME_LENGTH1=3 THEN
    vTIME_LEN_COL:=''QUARTER_MC'';
ELSIF vTIME_LENGTH1=1 THEN
    vTIME_LEN_COL:=''MONTH_MC'';
END IF;

SQL_STAT := '' SELECT MIN(DAY_DATE) as start_d,MAX(DAY_DATE) as end_d FROM %schema%.oo_DAY'';
SQL_STAT := SQL_STAT || '' WHERE oo_FUN_DAY(DAY_MC,''''''|| vTIME_LEN_COL ||'''''','''''' || vSTART_MONTH || '''''') = oo_FUN_DAY(oo_current_mc(),''''''|| vTIME_LEN_COL ||'''''','''''' || vSTART_MONTH || '''''')'';
for rec in execute SQL_STAT loop
	vKONKI_START_DATE := rec.start_d;
	vKONKI_END_DATE   := rec.end_d;
end loop;

	IF vTOTAL_FLG=''1'' THEN
		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level) values('';
		SQL_STAT := SQL_STAT || ''0,0,null,'';
		SQL_STAT := SQL_STAT || '''''''' || vNAME || '' 合計'''','''''' || vNAME || '' 合計'''','';
		SQL_STAT := SQL_STAT || ''null,0,0)'';
		execute SQL_STAT;
		PARENT_COLUMN:=''0'';
	END IF;

	IF vYEAR_FLG=''1'' THEN
		SELECT INTO vYEAR_L_NAME TIME_NAME_SQL
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''YEAR''
				AND TIME_NAME_FORMAT_CD = vYEAR_L_CODE;
		SELECT INTO vYEAR_S_NAME TIME_NAME_SQL 
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''YEAR''
				AND TIME_NAME_FORMAT_CD = vYEAR_S_CODE;

		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level)'';
		SQL_STAT := SQL_STAT || '' SELECT YEAR_MC,YEAR_MC,''|| PARENT_COLUMN ||'','';
		SQL_STAT := SQL_STAT || vYEAR_S_NAME || '','' || vYEAR_L_NAME || '','';
		SQL_STAT := SQL_STAT || ''year_date,''|| LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
		SQL_STAT := SQL_STAT || '' FROM %schema%.oo_YEAR'';
        SQL_STAT := SQL_STAT || '' WHERE YEAR_MC IN ('';
		SQL_STAT := SQL_STAT || '' SELECT DISTINCT oo_FUN_DAY(DAY_MC,''''YEAR_MC'''','''''' || vSTART_MONTH || '''''') FROM %schema%.oo_DAY'';
        SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
        SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '')) '';
		execute SQL_STAT;

		LEVEL_COUNTER:=LEVEL_COUNTER+1;
		PARENT_COLUMN:=''YEAR_MC'';
	END IF;

	IF vHALF_FLG=''1'' THEN
		SELECT INTO vHALF_L_NAME TIME_NAME_SQL
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''HALF''
				AND TIME_NAME_FORMAT_CD = vHALF_L_CODE;
		SELECT INTO vHALF_S_NAME TIME_NAME_SQL 
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''HALF''
				AND TIME_NAME_FORMAT_CD = vHALF_S_CODE;

		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level)'';
		SQL_STAT := SQL_STAT || '' SELECT HALF_MC,HALF_MC,''|| PARENT_COLUMN ||'','';
		SQL_STAT := SQL_STAT || vHALF_S_NAME || '','' || vHALF_L_NAME || '','';
		SQL_STAT := SQL_STAT || ''HALF_date,''|| LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
		SQL_STAT := SQL_STAT || '' FROM %schema%.oo_HALF'';
        SQL_STAT := SQL_STAT || '' WHERE HALF_MC IN ('';
		SQL_STAT := SQL_STAT || '' SELECT DISTINCT oo_FUN_DAY(DAY_MC,''''HALF_MC'''','''''' || vSTART_MONTH || '''''') FROM %schema%.oo_DAY'';
        SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
        SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '')) '';
		execute SQL_STAT;

		LEVEL_COUNTER:=LEVEL_COUNTER+1;
		PARENT_COLUMN:=''HALF_MC'';
	END IF;

	IF vQUARTER_FLG=''1'' THEN
		SELECT INTO vQUARTER_L_NAME TIME_NAME_SQL
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''QUARTER''
				AND TIME_NAME_FORMAT_CD = vQUARTER_L_CODE;
		SELECT INTO vQUARTER_S_NAME TIME_NAME_SQL 
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''QUARTER''
				AND TIME_NAME_FORMAT_CD = vQUARTER_S_CODE;

		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level)'';
		SQL_STAT := SQL_STAT || '' SELECT QUARTER_MC,QUARTER_MC,''|| PARENT_COLUMN ||'','';
		SQL_STAT := SQL_STAT || vQUARTER_S_NAME || '','' || vQUARTER_L_NAME || '','';
		SQL_STAT := SQL_STAT || ''QUARTER_date,''|| LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
		SQL_STAT := SQL_STAT || '' FROM %schema%.oo_QUARTER'';
        SQL_STAT := SQL_STAT || '' WHERE QUARTER_MC IN ('';
		SQL_STAT := SQL_STAT || '' SELECT DISTINCT oo_FUN_DAY(DAY_MC,''''QUARTER_MC'''','''''' || vSTART_MONTH || '''''') FROM %schema%.oo_DAY'';
        SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
        SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '')) '';
		execute SQL_STAT;

		LEVEL_COUNTER:=LEVEL_COUNTER+1;
		PARENT_COLUMN:=''QUARTER_MC'';
	END IF;

	IF vMONTH_FLG=''1'' THEN
		SELECT INTO vMONTH_L_NAME TIME_NAME_SQL
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''MONTH''
				AND TIME_NAME_FORMAT_CD = vMONTH_L_CODE;
		SELECT INTO vMONTH_S_NAME TIME_NAME_SQL 
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''MONTH''
				AND TIME_NAME_FORMAT_CD = vMONTH_S_CODE;

		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level)'';
		SQL_STAT := SQL_STAT || '' SELECT MONTH_MC,MONTH_MC,oo_FUN_MONTH(MONTH_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || ''''''),'';
		SQL_STAT := SQL_STAT || vMONTH_S_NAME || '','' || vMONTH_L_NAME || '','';
		SQL_STAT := SQL_STAT || ''MONTH_date,''|| LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
		SQL_STAT := SQL_STAT || '' FROM %schema%.oo_MONTH'';
        SQL_STAT := SQL_STAT || '' WHERE MONTH_MC IN ('';
		SQL_STAT := SQL_STAT || '' SELECT DISTINCT oo_FUN_DAY(DAY_MC,''''MONTH_MC'''','''''' || vSTART_MONTH || '''''') FROM %schema%.oo_DAY'';
        SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
        SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '')) '';
		execute SQL_STAT;

		LEVEL_COUNTER:=LEVEL_COUNTER+1;
		PARENT_COLUMN:=''MONTH_MC'';
	END IF;

	IF vWEEK_FLG=''1'' THEN
		SELECT INTO vWEEK_L_NAME TIME_NAME_SQL
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''WEEK_'' || vWEEK_KIND_FLG
				AND TIME_NAME_FORMAT_CD = vWEEK_L_CODE;
		SELECT INTO vWEEK_S_NAME TIME_NAME_SQL 
			FROM %schema%.oo_TIME_FORMAT
			WHERE TIME_KIND_CD = ''WEEK_'' || vWEEK_KIND_FLG
				AND TIME_NAME_FORMAT_CD = vWEEK_S_CODE;

		SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
		SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,time_date,org_level,cust_level)'';
		SQL_STAT := SQL_STAT || '' SELECT DISTINCT oo_FUN_WEEK(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || '''''','''''' || vWEEK_KIND_FLG || ''''''),'';
		SQL_STAT := SQL_STAT || '' oo_FUN_WEEK(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || '''''','''''' || vWEEK_KIND_FLG || ''''''),'';
		SQL_STAT := SQL_STAT || '' oo_FUN_DAY(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || ''''''),'';
		SQL_STAT := SQL_STAT || '' oo_FUN_WEEK_DATE(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || '''''','''''' || vWEEK_KIND_FLG || ''''''),'';
		SQL_STAT := SQL_STAT || LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
		SQL_STAT := SQL_STAT || '' FROM %schema%.oo_DAY'';
        SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
        SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '') '';
		execute SQL_STAT;
	    SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1'';
	    SQL_STAT := SQL_STAT || '' SET long_name='' || vWEEK_L_NAME;
	    SQL_STAT := SQL_STAT || '',short_name='' || vWEEK_S_NAME;
	    SQL_STAT := SQL_STAT || '' WHERE long_name IS NULL AND short_name IS NULL'';
	    SQL_STAT := SQL_STAT || '' AND ORG_LEVEL='' || LEVEL_COUNTER;
		execute SQL_STAT;

		LEVEL_COUNTER:=LEVEL_COUNTER+1;
		PARENT_COLUMN:=''WEEK_MC'';
	END IF;

	IF vDAY_L_CODE = '''' THEN
		vDAY_L_CODE:=''01'';
	END IF;
	IF vDAY_S_CODE = '''' THEN
		vDAY_S_CODE:=''01'';
	END IF;

	SELECT INTO vDAY_L_NAME TIME_NAME_SQL
		FROM %schema%.oo_TIME_FORMAT
		WHERE TIME_KIND_CD = ''DAY''
			AND TIME_NAME_FORMAT_CD = vDAY_L_CODE;
	SELECT INTO vDAY_S_NAME TIME_NAME_SQL 
		FROM %schema%.oo_TIME_FORMAT
		WHERE TIME_KIND_CD = ''DAY''
			AND TIME_NAME_FORMAT_CD = vDAY_S_CODE;

	SQL_STAT := ''INSERT INTO oo_dim_'' || TIME_ID || ''_1'';
	SQL_STAT := SQL_STAT || ''(key,sort_col,par_key,short_name,long_name,time_date,org_level,cust_level)'';
	IF PARENT_COLUMN=''WEEK_MC'' THEN
		SQL_STAT := SQL_STAT || '' SELECT DAY_MC,DAY_MC,oo_FUN_WEEK(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || '''''','''''' || vWEEK_KIND_FLG || ''''''),'';
	ELSE
		SQL_STAT := SQL_STAT || '' SELECT DAY_MC,DAY_MC,oo_FUN_DAY(DAY_MC,'''''' || PARENT_COLUMN || '''''','''''' || vSTART_MONTH || ''''''),'';
	END IF;
	SQL_STAT := SQL_STAT || vDAY_S_NAME || '','' || vDAY_L_NAME || '','';
	SQL_STAT := SQL_STAT || ''DAY_date,''|| LEVEL_COUNTER || '','' || LEVEL_COUNTER || '' '';
	SQL_STAT := SQL_STAT || '' FROM %schema%.oo_DAY'';
	SQL_STAT := SQL_STAT || '' WHERE DAY_DATE BETWEEN oo_add_months('''''' || vKONKI_START_DATE || '''''','' || vTIME_PAST_SPAN1*vTIME_LENGTH1*-1 || '') '';
	SQL_STAT := SQL_STAT || '' AND oo_add_months('''''' || vKONKI_END_DATE || '''''','' || vTIME_FUTURE_SPAN1*vTIME_LENGTH1 || '') '';

	execute SQL_STAT;

	if vDAY_FLG = ''1'' then
		SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1 SET LEAF_FLG=''''0'''' WHERE ORG_LEVEL<''||LEVEL_COUNTER;
		execute SQL_STAT;
		SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1 SET LEAF_FLG=''''1'''' WHERE ORG_LEVEL=''||LEVEL_COUNTER;
		execute SQL_STAT;
	else
		SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1 SET LEAF_FLG=''''0'''' WHERE ORG_LEVEL<''||LEVEL_COUNTER-1;
		execute SQL_STAT;
		SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1 SET LEAF_FLG=''''1'''' WHERE ORG_LEVEL=''||LEVEL_COUNTER-1;
		execute SQL_STAT;
		SQL_STAT := ''UPDATE oo_dim_'' || TIME_ID || ''_1 SET LEAF_FLG=''''9'''' WHERE ORG_LEVEL=''||LEVEL_COUNTER;
		execute SQL_STAT;
	end if;

	return SQL_STAT;

END;
'LANGUAGE 'plpgsql';
/



create or replace function %schema%.oo_time_limit(integer,char(1),integer,integer) returns text as '
DECLARE

	Time_seq            ALIAS FOR $1;
	Time_kind           ALIAS FOR $2;
	past_len            ALIAS FOR $3;
	future_len          ALIAS FOR $4;

	start_time_key      integer;
	end_time_key        integer;
	now_time_key		integer;

	time_kind_level		numeric(2,0);
	max_time_level		numeric(2,0);
	now_level			numeric(2,0);

	vRt					varchar(10);
	vTableName			varchar(50);

	vSQL				text;
	rec					record;
BEGIN
	vRt:=''\n'';
	vTableName:=''oo_dim_'' || Time_seq || ''_1'';
	max_time_level:=0;
	time_kind_level:=0;
	vSQL:=''update '' || vTableName;
	vSQL := vSQL || '' set min_val = null,max_val=null'';
	execute vSQL;

	select into now_time_key oo_current_mc();
	LOOP
		vSQL := '' SELECT par_key,org_level FROM '' || vTableName || '' WHERE key='' || now_time_key;

		for rec in execute vSQL loop
			time_kind_level:=rec.org_level;
			if max_time_level=0 then
				max_time_level:=rec.org_level;
			end if;
		end loop;
		IF    Time_kind = ''Y'' and substr(now_time_key,9,1)=''1'' THEN
			EXIT;
		elsif Time_kind = ''H'' and substr(now_time_key,9,1)=''2'' THEN
			EXIT;
		elsif Time_kind = ''Q'' and substr(now_time_key,9,1)=''3'' THEN
			EXIT;
		elsif Time_kind = ''M'' and substr(now_time_key,9,1)=''4'' THEN
			EXIT;
		elsif Time_kind = ''W'' and substr(now_time_key,9,1)=''5'' THEN
			EXIT;
		elsif Time_kind = ''W'' and substr(now_time_key,9,1)=''6'' THEN
			EXIT;
		elsif Time_kind = ''D'' and substr(now_time_key,9,1)=''7'' THEN
--			vSQL := '' SELECT par_key,org_level FROM '' || vTableName || '' WHERE key='' || now_time_key;
--			for rec in execute vSQL loop
--				time_kind_level:=rec.org_level;
--				max_time_level:=rec.org_level;
--			end loop;
			EXIT;
		elsif Time_kind = ''A'' THEN
			vSQL:=''update '' || vTableName;
			vSQL := vSQL || '' set min_val = 1,max_val=1'';
			execute vSQL;
			return ''All Time Members ,,,, DataLoad and Rollup !'';
		else
			vSQL := '' SELECT par_key,org_level FROM '' || vTableName || '' WHERE key='' || now_time_key;
			for rec in execute vSQL loop
				now_time_key := rec.par_key;
--				time_kind_level:=rec.org_level;
--				if max_time_level=0 then
--					max_time_level:=rec.org_level;
--				end if;
			end loop;
		END IF;
	END LOOP;

--return now_time_key || time_kind_level || max_time_level;

	if past_len>=0 then
		vSQL := '' select key from '' || vTableName;
		vSQL := vSQL || '' where key <= '' || now_time_key || ''and substr(key,9,1)=substr(''||now_time_key||'',9,1)'';
		vSQL := vSQL || '' order by key desc limit 1 offset '' || cast(abs(past_len) as text);
	else
		vSQL := '' select key from '' || vTableName;
		vSQL := vSQL || '' where key >= '' || now_time_key || ''and substr(key,9,1)=substr(''||now_time_key||'',9,1)'';
		vSQL := vSQL || '' order by key limit 1 offset '' || cast(abs(past_len) as text);---revers plus minus
	end if;
	for rec in execute vSQL loop
		start_time_key := rec.key;
	end loop;
	if start_time_key is null then
		start_time_key:=''10000000'' || substr(now_time_key,9,1);
	end if;

	if future_len>=0 then
		vSQL := '' select key from '' || vTableName;
		vSQL := vSQL || '' where key >= '' || now_time_key || ''and substr(key,9,1)=substr(''||now_time_key||'',9,1)'';
		vSQL := vSQL || '' order by key limit 1 offset '' || cast(abs(future_len) as text);
	else
		vSQL := '' select key from '' || vTableName;
		vSQL := vSQL || '' where key <= '' || now_time_key || ''and substr(key,9,1)=substr(''||now_time_key||'',9,1)'';
		vSQL := vSQL || '' order by key desc limit 1 offset '' || cast(abs(future_len) as text);---revers plus minus
	end if;
	for rec in execute vSQL loop
		end_time_key := rec.key;
	end loop;
	if end_time_key is null then
		end_time_key:=''29990000'' || substr(now_time_key,9,1);
	end if;


	--バッチで指定されたLevelにFLGを立てる。
	vSQL := '' update '' || vTableName;
	vSQL := vSQL || '' set min_val = 1'';
	vSQL := vSQL || '' where key between '' || start_time_key || '' and '' || end_time_key;
	vSQL := vSQL || '' and org_level=''||time_kind_level;
--return vSQL;
	execute vSQL;

	--子供にFLGを立てる。
	for now_level in time_kind_level .. max_time_level-1 loop
		vSQL:=''update '' || vTableName;
		vSQL := vSQL || '' set min_val = 1'';
		vSQL := vSQL || '' where org_level=''|| now_level+1 ||''and par_key in '';
		vSQL := vSQL || '' (select key from '' || vTableName || '' where org_level=''|| now_level;
		vSQL := vSQL || '' and min_val=1)'';
--return vSQL;
		execute vSQL;
	end loop;

--return ''aaa   ''||vSQL;
	--親にFlgを立てる。
	for now_level in reverse time_kind_level .. -1 loop
		vSQL:=''update '' || vTableName;
		vSQL := vSQL || '' set min_val = 1'';
		vSQL := vSQL || '' where key in '';
		vSQL := vSQL || '' (select distinct par_key from '' || vTableName || '' where org_level=''|| now_level;
		vSQL := vSQL || '' and min_val=1)'';

		execute vSQL;
	end loop;

	---集計Flgを立てる。
	for now_level in reverse max_time_level .. 0 loop
		vSQL:=''update '' || vTableName;
		vSQL := vSQL || '' set max_val = 1'';
		vSQL := vSQL || '' where par_key in '';
		vSQL := vSQL || '' (select par_key from '' || vTableName || '' where org_level=''|| now_level;
		vSQL := vSQL || '' and min_val=1)'';
		execute vSQL;
	end loop;

	return vSQL;

END;
'LANGUAGE 'plpgsql';
/



CREATE FUNCTION %schema%.oo_dim_sql(integer,char(1),varchar(60)) RETURNS text AS '
DECLARE

	vDIMENSION_SEQ			ALIAS FOR $1;
	vFLG					ALIAS FOR $2;
	vSchema_NAME			ALIAS FOR $3;
	vSQL					TEXT;
		vSELECT				TEXT;
			vKEY_COL		TEXT;
			vLINK_COL		TEXT;
		vFROM				TEXT;
			vPreFROM		varchar(30);
		vWHERE				TEXT;
			vPreWHERE		varchar(30);
			vFirstWHERE		varchar(30);
			vPa_key_col1	varchar(30);
			vPa_key_col2	varchar(30);
			vPa_key_col3	varchar(30);
			vPa_key_col4	varchar(30);
			vPa_key_col5	varchar(30);
		vORDERBY			TEXT;
		vComma				varchar(1);
		vAnd				varchar(3);
	vRt						varchar(10);

	vCnt					integer;
	rec						record;
	cu cursor for 
		select * from %schema%.oo_level
		where dimension_seq = vDIMENSION_SEQ
		order by level_no;

BEGIN
	vSELECT	:=''select '';
		vLINK_COL:='''';
	vFROM	:=''\n from '';	
		vPreFROM := '''';
	vWHERE	:='''';
		vFirstWHERE :=''\n where '';
		vPreWHERE := '''';
	vORDERBY:='' \n order by '';
	vRt:=''\n       '';

	vCnt:=0;
	open cu;
	loop
		fetch cu into rec;
		if not found then
			exit;
		end if;
--*******************Select*************************
		vCnt:=vCnt+1;
			if vCnt = 1 then
				vComma:='' '';
			else
				vComma:='','';
			end if;
			if rec.key_col1 != '''' then
				vKEY_COL :=  vComma || ''cast('' ||rec.table_name || ''.'' || rec.key_col1 || '' as varchar) as key'' || vCnt || ''_1'';
			end if;
			if rec.key_col2 != '''' then
				vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col2 || '' as varchar) as key'' || vCnt || ''_2'';
			elsif vFLG =''1'' then
				vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_2'';
			end if;
			if rec.key_col3 != '''' then
				vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col3 || '' as varchar) as key'' || vCnt || ''_3'';
			elsif vFLG =''1'' then
				vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_3'';
			end if;
			if rec.key_col4 != '''' then
				vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col4 || '' as varchar) as key'' || vCnt || ''_4'';
			elsif vFLG =''1'' then
				vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_4'';
			end if;
			if rec.key_col5 != '''' then
				vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col5 || '' as varchar) as key'' || vCnt || ''_5'';
			elsif vFLG =''1'' then
				vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_5'';
			end if;

			if rec.link_col1 != '''' then
				vLINK_COL := '', cast('' || rec.table_name || ''.'' || rec.link_col1 || '' as varchar) as pa_key'' || vCnt || ''_1'';
			end if;
			if rec.link_col2 != '''' then
				vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col2 || '' as varchar) as pa_key'' || vCnt || ''_2'';
--			elsif vFLG =''1'' then
--				vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_2'';
			end if;
			if rec.link_col3 != '''' then
				vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col3 || '' as varchar) as pa_key'' || vCnt || ''_3'';
--			elsif vFLG =''1'' then
--				vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_3'';
			end if;
			if rec.link_col4 != '''' then
				vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col4 || '' as varchar) as pa_key'' || vCnt || ''_4'';
--			elsif vFLG =''1'' then
--				vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_4'';
			end if;
			if rec.link_col5 != '''' then
				vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col5 || '' as varchar) as pa_key'' || vCnt || ''_5'';
--			elsif vFLG =''1'' then
--				vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_5'';
			end if;

		vSELECT := vSELECT || vRt || vKEY_COL;
		vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.long_name_col || '' as varchar) as LONG_NAME'' || vCnt;
		vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.short_name_col || '' as varchar) as SHORT_NAME'' || vCnt;
		vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.sort_col || '' as varchar) as SORT'' || vCnt;
		if vCnt=1 then
		else
			vSELECT := vSELECT || vRt || vLINK_COL;
		end if;
--*******************FROM*************************
		if vPreFROM != rec.table_name then
			vFROM := vFROM || vRt || vComma || vSchema_NAME || ''.'' || rec.table_name;
			vPreFROM:=rec.table_name;
		end if;
--*******************WHERE*************************
		if vCnt = 1 then
		else
			if vPreWHERE != rec.table_name then
				vWHERE := vWHERE || vFirstWHERE || vRt  || vPreWHERE || ''.'' || vPa_key_col1 || '' = '' || rec.table_name || ''.'' || rec.link_col1;
				if rec.link_col2!='''' then
					vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col2 || '' = '' || rec.table_name || ''.'' || rec.link_col2;
				end if;
				if rec.link_col3!='''' then
					vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col3 || '' = '' || rec.table_name || ''.'' || rec.link_col3;
				end if;
				if rec.link_col4!='''' then
					vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col4 || '' = '' || rec.table_name || ''.'' || rec.link_col4;
				end if;
				if rec.link_col5!='''' then
					vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col5 || '' = '' || rec.table_name || ''.'' || rec.link_col5;
				end if;

				vFirstWHERE:='' and '';
			end if;
		end if;

		if rec.where_clause != '''' then
			vWHERE := vWHERE || vFirstWHERE || rec.where_clause;
			vFirstWHERE :='' and '';
		end if;
		vPa_key_col1:=rec.key_col1;
		vPa_key_col2:=rec.key_col2;
		vPa_key_col3:=rec.key_col3;
		vPa_key_col4:=rec.key_col4;
		vPa_key_col5:=rec.key_col5;
		vPreWHERE := rec.table_name;

--*******************Order by*************************
		vORDERBY := vORDERBY || vRt || vComma || ''SORT'' || vCnt;

	end loop;
	close cu;

--	if vFLG =''1'' then
--		for i in vCnt..15 loop
--			vSELECT:=vSELECT || ''a'';
--		end loop;
--	end if;

	vSQL := vSELECT || vFROM || vWHERE || vORDERBY;
	return vSQL;
END;
'LANGUAGE 'plpgsql';
/

CREATE or replace FUNCTION %schema%.oo_segment_dim_sql(integer,char(1),varchar(60)) RETURNS text AS '
DECLARE

	vDIMENSION_SEQ			ALIAS FOR $1;
	vFLG					ALIAS FOR $2;-----Seg Data Type 1:Number 2:char
	vSchema_NAME			ALIAS FOR $3;
	vSQL					TEXT;
		vSegCol				TEXT;
		vSELECT				TEXT;
			vKEY_COL		TEXT;
			vLINK_COL		TEXT;
		vFROM				TEXT;
			vPreFROM		varchar(30);
		vWHERE				TEXT;
			vPreWHERE		varchar(30);
			vFirstWHERE		varchar(30);
			vPa_key_col1	varchar(30);
			vPa_key_col2	varchar(30);
			vPa_key_col3	varchar(30);
			vPa_key_col4	varchar(30);
			vPa_key_col5	varchar(30);
		vORDERBY			TEXT;
		vComma				varchar(1);
		vAnd				varchar(3);
	vRt						varchar(10);

	vCnt					integer;
	rec						record;
	cu cursor for 
		select * from %schema%.oo_level
		where dimension_seq = vDIMENSION_SEQ
		order by level_no;

BEGIN

	vSegCol	:=''select '';
	vSELECT	:='' '';
		vLINK_COL:='''';
	vFROM	:=''\n from '';	
		vPreFROM := '''';
	vWHERE	:='''';
		vFirstWHERE :=''\n where '';
		vPreWHERE := '''';
	vORDERBY:='' \n order by '';
	vRt:=''\n       '';

	vCnt:=0;
	open cu;
	loop
		fetch cu into rec;
		if not found then
			exit;
		end if;
--*******************Select*************************
		vCnt:=vCnt+1;
			if vCnt = 1 or vCnt=2 then
				vComma:='' '';
			else
				vComma:='','';
			end if;
		if vCnt=1 then
			if vFLG=''1'' then-----Number
				vSegCol :=  vSegCol || ''cast('' ||rec.table_name || ''.'' || rec.key_col1 || '' as numeric) as min_val''|| vRt;
				vSegCol :=  vSegCol || '',varchar '' || '''''''''''' || '' as  calc_text,'';
			else-----Char
				vSegCol :=  vSegCol || ''null as min_val''|| vRt;
				vSegCol :=  vSegCol || '',cast('' ||rec.table_name || ''.'' || rec.key_col1 || '' as varchar) as calc_text,'';
			end if;
		else
				if rec.key_col1 != '''' then
					vKEY_COL :=  vComma || ''cast('' ||rec.table_name || ''.'' || rec.key_col1 || '' as varchar) as key'' || vCnt || ''_1'';
				end if;
				if rec.key_col2 != '''' then
					vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col2 || '' as varchar) as key'' || vCnt || ''_2'';
				else
					vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_2'';
				end if;
				if rec.key_col3 != '''' then
					vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col3 || '' as varchar) as key'' || vCnt || ''_3'';
				else
					vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_3'';
				end if;
				if rec.key_col4 != '''' then
					vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col4 || '' as varchar) as key'' || vCnt || ''_4'';
				else
					vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_4'';
				end if;
				if rec.key_col5 != '''' then
					vKEY_COL := vKEY_COL || '' , cast('' || rec.table_name || ''.'' || rec.key_col5 || '' as varchar) as key'' || vCnt || ''_5'';
				else
					vKEY_COL := vKEY_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_5'';
				end if;

				if rec.link_col1 != '''' then
					vLINK_COL := '', cast('' || rec.table_name || ''.'' || rec.link_col1 || '' as varchar) as pa_key'' || vCnt || ''_1'';
				end if;
				if rec.link_col2 != '''' then
					vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col2 || '' as varchar) as pa_key'' || vCnt || ''_2'';
				else
					vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_2'';
				end if;
				if rec.link_col3 != '''' then
					vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col3 || '' as varchar) as pa_key'' || vCnt || ''_3'';
				else
					vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_3'';
				end if;
				if rec.link_col4 != '''' then
					vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col4 || '' as varchar) as pa_key'' || vCnt || ''_4'';
				else
					vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_4'';
				end if;
				if rec.link_col5 != '''' then
					vLINK_COL := vLINK_COL || '' , cast('' || rec.table_name || ''.'' || rec.link_col5 || '' as varchar) as pa_key'' || vCnt || ''_5'';
				else
					vLINK_COL := vLINK_COL || vRt || '', varchar '' || '''''''''''' || '' as key'' || vCnt || ''_5'';
				end if;

			vSELECT := vSELECT || vRt || vKEY_COL;
			vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.long_name_col || '' as varchar) as LONG_NAME'' || vCnt;
			vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.short_name_col || '' as varchar) as SHORT_NAME'' || vCnt;
			vSELECT := vSELECT || vRt || '', cast('' || rec.table_name || ''.'' || rec.sort_col || '' as varchar) as SORT'' || vCnt;
			if vCnt=1 then
			else
				vSELECT := vSELECT || vRt || vLINK_COL;
			end if;
	--*******************FROM*************************
			if vPreFROM != rec.table_name then
				vFROM := vFROM || vRt || vComma || vSchema_NAME || ''.'' || rec.table_name;
				vPreFROM:=rec.table_name;
			end if;
	--*******************WHERE*************************
			if vCnt = 1 or vCnt=2 then
			else
				if vPreWHERE != rec.table_name then
					vWHERE := vWHERE || vFirstWHERE || vRt  || vPreWHERE || ''.'' || vPa_key_col1 || '' = '' || rec.table_name || ''.'' || rec.link_col1;
					if rec.link_col2!='''' then
						vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col2 || '' = '' || rec.table_name || ''.'' || rec.link_col2;
					end if;
					if rec.link_col3!='''' then
						vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col3 || '' = '' || rec.table_name || ''.'' || rec.link_col3;
					end if;
					if rec.link_col4!='''' then
						vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col4 || '' = '' || rec.table_name || ''.'' || rec.link_col4;
					end if;
					if rec.link_col5!='''' then
						vWHERE := vWHERE || '' and '' || vRt  || vPreWHERE || ''.'' || vPa_key_col5 || '' = '' || rec.table_name || ''.'' || rec.link_col5;
					end if;

					vFirstWHERE:='' and '';
				end if;
			end if;

			if rec.where_clause != '''' then
				vWHERE := vWHERE || vFirstWHERE || rec.where_clause;
				vFirstWHERE :='' and '';
			end if;
			vPa_key_col1:=rec.key_col1;
			vPa_key_col2:=rec.key_col2;
			vPa_key_col3:=rec.key_col3;
			vPa_key_col4:=rec.key_col4;
			vPa_key_col5:=rec.key_col5;
			vPreWHERE := rec.table_name;

	--*******************Order by*************************
			vORDERBY := vORDERBY || vRt || vComma || ''SORT'' || vCnt;
--return vSegCol || vSELECT || vFROM || vWHERE || vORDERBY;

		end if;
	end loop;
	close cu;

--	if vFLG =''1'' then
--		for i in vCnt..15 loop
--			vSELECT:=vSELECT || ''a'';
--		end loop;
--	end if;

	vSQL := vSegCol || vSELECT || vFROM || vWHERE || vORDERBY;
	return vSQL;
END;
'LANGUAGE 'plpgsql';
/


CREATE FUNCTION %schema%.oo_dim_member(integer,varchar(60)) RETURNS text AS '
DECLARE

	vDIMENSION_SEQ			ALIAS FOR $1;
	vSchema_NAME			ALIAS FOR $2;
	vSQL					TEXT;
	vCountSQL				TEXT;
	vInsertSQL				TEXT;
	vUpdateSQL				TEXT;
	rec 					record;
	recCnt 					record;
	recSeq					record;
	vRt						varchar(10);
	vCnt					integer;
	vKey					integer;
	vPaKey					varchar(5);
	vTempPaKey				varchar(5);
	vPreRecKey				integer[7];--level 1-6

	hieT					oo_dim_0_0%rowtype;

	vMaxLevel				integer;
	vMinLevel				integer;---------NormalDim:1  SegmentDim:2
	vTotal_Flg				varchar(1);
	vNAME					varchar(50);
	vDim_Type				varchar(1);
	vSeg_DataType			varchar(1);

BEGIN
	vRt:=''\n'';
	vCnt:=1;

	select into vMaxLevel max(level_no) from oo_level where dimension_seq=vDIMENSION_SEQ;
	select into vTotal_Flg,vNAME,vDim_Type,vSeg_DataType total_flg,name,dim_type,seg_datatype from oo_dimension where dimension_seq=vDIMENSION_SEQ;

	if vTotal_Flg = ''1'' then
		vCountSQL := ''select count(*) as cnt '' || vRt;
		vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
		vCountSQL := vCountSQL || '' where key = 0'' || vRt;
		for recCnt in execute vCountSQL loop
			if recCnt.cnt = 0 then
				execute ''insert into oo_dim_'' || vDIMENSION_SEQ || ''_1(key,par_key,short_name,long_name,leaf_flg,org_level,sort_col) values(0,null,''''''|| vNAME ||'' 合計'''',''''''|| vNAME ||'' 合計'''',''''0'''',0,0)'';
			else
				execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set short_name=''''''|| vNAME ||'' 合計'''',long_name = ''''''|| vNAME ||'' 合計'''' where key=0'';
			end if;
		end loop;
		vTempPaKey:=0;
	else
		execute ''delete from oo_dim_'' || vDIMENSION_SEQ || ''_1  where key = 0'';
		execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set par_key = null where par_key=0'';
		vTempPaKey:=''null'';
	end if;

	if vDim_Type = ''2'' then
		--その他レコードがあれば、書きかえる。
		if vTotal_Flg = ''1'' then
			execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set short_name=''''その他'''',long_name = ''''その他'''',par_key=0,org_level=0 where key=-1'';
		else
			execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set short_name=''''その他'''',long_name = ''''その他'''',par_key=null,org_level=0 where key=-1'';
		end if;
		if vMaxLevel = 1 then
			return ''Segment Dimension and Segment Level Only !!'';
		else
--			vMaxLevel:=vMaxLevel-1;
		end if;
	end if;

----------------------------------------------------------------------------------------------------------
--	execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set org_level=-1 where org_level != 0'';
	execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_1 set leaf_flg=''''8'''' where org_level != 0'';
----------------------------------------------------------------------------------------------------------

	if vDim_Type = ''1'' then
		select into vSQL oo_dim_sql(vDIMENSION_SEQ,''1'',vSchema_NAME);
	else
		select into vSQL oo_segment_dim_sql(vDIMENSION_SEQ,vSeg_DataType,vSchema_NAME);
	end if;

--return vSQL;
	for rec in execute vSQL loop
		vPaKey:=vTempPaKey;

		if vDim_Type = ''1'' then------Normal Dim
			vMinLevel:=1;
		else----Segment
			vMinLevel:=2;
		end if;

		for i in vMinLevel..vMaxLevel loop
			if i=1 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key1_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key1_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key1_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key1_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key1_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 1'' || vRt;
--return vCountSQL;
				hieT.col_1:=rec.key1_1;
				hieT.col_2:=rec.key1_2;
				hieT.col_3:=rec.key1_3;
				hieT.col_4:=rec.key1_4;
				hieT.col_5:=rec.key1_5;
				hieT.sort_col:=rec.sort1;
				hieT.short_name:=rec.short_name1;
				hieT.long_name:=rec.long_name1;
				hieT.org_level:=1;
			elsif i=2 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key2_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key2_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key2_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key2_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key2_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 2'' || vRt;
--return vCountSQL;
				hieT.col_1:=rec.key2_1;
				hieT.col_2:=rec.key2_2;
				hieT.col_3:=rec.key2_3;
				hieT.col_4:=rec.key2_4;
				hieT.col_5:=rec.key2_5;
				hieT.sort_col:=rec.sort2;
				hieT.short_name:=rec.short_name2;
				hieT.long_name:=rec.long_name2;
				hieT.org_level:=2;
				if vDim_Type = ''2'' then------Segment Dim
					hieT.min_val:=rec.min_val;
					hieT.calc_text:=rec.calc_text;
				end if;
			elsif i=3 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key3_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key3_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key3_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key3_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key3_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 3'' || vRt;
				hieT.col_1:=rec.key3_1;
				hieT.col_2:=rec.key3_2;
				hieT.col_3:=rec.key3_3;
				hieT.col_4:=rec.key3_4;
				hieT.col_5:=rec.key3_5;
				hieT.sort_col:=rec.sort3;
				hieT.short_name:=rec.short_name3;
				hieT.long_name:=rec.long_name3;
				hieT.org_level:=3;
			elsif i=4 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key4_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key4_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key4_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key4_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key4_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 4'' || vRt;
				hieT.col_1:=rec.key4_1;
				hieT.col_2:=rec.key4_2;
				hieT.col_3:=rec.key4_3;
				hieT.col_4:=rec.key4_4;
				hieT.col_5:=rec.key4_5;
				hieT.sort_col:=rec.sort4;
				hieT.short_name:=rec.short_name4;
				hieT.long_name:=rec.long_name4;
				hieT.org_level:=4;
			elsif i=5 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key5_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key5_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key5_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key5_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key5_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 5'' || vRt;
				hieT.col_1:=rec.key5_1;
				hieT.col_2:=rec.key5_2;
				hieT.col_3:=rec.key5_3;
				hieT.col_4:=rec.key5_4;
				hieT.col_5:=rec.key5_5;
				hieT.sort_col:=rec.sort5;
				hieT.short_name:=rec.short_name5;
				hieT.long_name:=rec.long_name5;
				hieT.org_level:=5;
			elsif i=6 then
				vCountSQL := ''select count(*) as cnt,max(key) as k'' || vRt;
				vCountSQL := vCountSQL || '' from oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
				vCountSQL := vCountSQL || '' where col_1 = '''''' || rec.key6_1 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_2 = '''''' || rec.key6_2 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_3 = '''''' || rec.key6_3 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_4 = '''''' || rec.key6_4 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and col_5 = '''''' || rec.key6_5 || '''''''' || vRt;
				vCountSQL := vCountSQL || '' and org_level = 6'' || vRt;
				hieT.col_1:=rec.key6_1;
				hieT.col_2:=rec.key6_2;
				hieT.col_3:=rec.key6_3;
				hieT.col_4:=rec.key6_4;
				hieT.col_5:=rec.key6_5;
				hieT.sort_col:=rec.sort6;
				hieT.short_name:=rec.short_name6;
				hieT.long_name:=rec.long_name6;
				hieT.org_level:=6;
			end if;
			if vMaxLevel=i then
				hieT.leaf_flg:=1;
			else
				hieT.leaf_flg:=0;
			end if;

			for recCnt in execute vCountSQL loop
--return vCountSQL || recCnt.cnt;
				if recCnt.cnt = 0 then
					for recSeq in execute ''select nextval(''''oo_s_dim_'' || vDIMENSION_SEQ || ''_seq'''') as seq'' loop
						vKey=recSeq.seq;
					end loop;

					vInsertSQL:= ''insert into oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
					vInsertSQL:= vInsertSQL|| '' (key,par_key,col_1,col_2,col_3,col_4,col_5,sort_col,code,short_name,long_name,org_level,leaf_flg,min_val,calc_text)'' || vRt;
					vInsertSQL:= vInsertSQL|| '' values('' || vKey || vRt;
					vInsertSQL:= vInsertSQL|| '' ,'' || vPaKey;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_1 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_2 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_3 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_4 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_5 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.sort_col || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.col_1 || hieT.col_2 || hieT.col_3 || hieT.col_4 || hieT.col_5 || '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.short_name|| '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.long_name|| '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.org_level|| '''''''' || vRt;
					vInsertSQL:= vInsertSQL|| '','''''' || hieT.leaf_flg|| '''''''' || vRt;
					if hieT.min_val is null then
						vInsertSQL:= vInsertSQL|| '',null'' || vRt;
					else
						vInsertSQL:= vInsertSQL|| '','''''' || hieT.min_val || '''''''' || vRt;
					end if;
					if hieT.calc_text is null then
						vInsertSQL:= vInsertSQL|| '','''''' || '''' || '''''')'' || vRt;
					else
						vInsertSQL:= vInsertSQL|| '','''''' || hieT.calc_text || '''''')'' || vRt;
					end if;
					execute vInsertSQL;
				else--update or same record
						vUpdateSQL:= ''update oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' set '' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' par_key  ='' || vPaKey || '''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '',sort_col  ='''''' || hieT.sort_col || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '',code      ='''''' || hieT.col_1 || hieT.col_2 || hieT.col_3 || hieT.col_4 || hieT.col_5 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '',short_name='''''' || hieT.short_name|| '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '',long_name ='''''' || hieT.long_name|| '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '',leaf_flg  ='''''' || hieT.leaf_flg|| '''''''' || vRt;
						if hieT.min_val is null then
							vUpdateSQL:= vUpdateSQL|| '',min_val = null '' || vRt;
						else
							vUpdateSQL:= vUpdateSQL|| '',min_val = '' || hieT.min_val || vRt;
						end if;
						if hieT.calc_text is null then
							vUpdateSQL:= vUpdateSQL|| '',calc_text  ='''''' || '''' || '''''''' || vRt;
						else
							vUpdateSQL:= vUpdateSQL|| '',calc_text  ='''''' || hieT.calc_text || '''''''' || vRt;
						end if;
						vUpdateSQL:= vUpdateSQL|| '' where col_1 = '''''' || hieT.col_1 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' and col_2 = '''''' || hieT.col_2 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' and col_3 = '''''' || hieT.col_3 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' and col_4 = '''''' || hieT.col_4 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' and col_5 = '''''' || hieT.col_5 || '''''''' || vRt;
						vUpdateSQL:= vUpdateSQL|| '' and org_level ='''''' || hieT.org_level|| '''''''' || vRt;
						execute vUpdateSQL;
					vKey:=recCnt.k;
				end if;
				vPaKey:=vKey;
			end loop;
		end loop;
	end loop;

----------------------------------------------------------------------------------------------------------
--	execute ''delete from oo_dim_'' || vDIMENSION_SEQ || ''_1 where org_level=-1'';
	execute ''delete from oo_dim_'' || vDIMENSION_SEQ || ''_1 where leaf_flg=''''8'''''';
----------------------------------------------------------------------------------------------------------

	if vDim_Type = ''2'' then
--		select into vName key_col1 from oo_level where dimension_seq=vDIMENSION_SEQ and level_no=1;
		if vSeg_DataType = ''1'' then -- numeric
			vSQL:=''oo_seg_func_'' || vDIMENSION_SEQ || ''_1('' || ''min_val'' || '',null)'';
		else-----character
			vSQL:=''oo_seg_func_'' || vDIMENSION_SEQ || ''_1(null,'' || ''calc_text'' || '')'';
		end if;
--return vSQL;
		vUpdateSQL:= ''update oo_dim_'' || vDIMENSION_SEQ || ''_1'' || vRt;
		vUpdateSQL:= vUpdateSQL|| '' set '' || vRt;
		vUpdateSQL:= vUpdateSQL|| '' par_key  = '' || vSQL || vRt;
		vUpdateSQL:= vUpdateSQL|| '' where org_level = 2 '' || vRt;

--return vUpdateSQL;
		execute vUpdateSQL;
	end if;

	return vCountSQL;
END;
'LANGUAGE 'plpgsql';
/

CREATE OR REPLACE FUNCTION %schema%.oo_dim_tree(varchar(30),text,text) RETURNS SETOF oo_dim_0_0 AS '
DECLARE
	table_name		ALIAS FOR $1;--SETOF oo_dim_0_0
	parentRec		ALIAS FOR $2;
	whereIn			ALIAS FOR $3;

	ret 			oo_dim_0_0%rowtype;

	sql1			text;
	sql2			text;
	sql3			text;
	sql4			text;
	sql5			text;
	sql6			text;
	sql7			text;
	sql8			text;
	sql9			text;
	sql10			text;
	sql11			text;
	sql12			text;
	sql13			text;
	sql14			text;
	sql15			text;
	sql16			text;

	vRt				varchar(10);

	rec1				record;
	rec2				record;
	rec3				record;
	rec4				record;
	rec5				record;
	rec6				record;
	rec7				record;
	rec8				record;
	rec9				record;
	rec10				record;
	rec11				record;
	rec12				record;
	rec13				record;
	rec14				record;
	rec15				record;
	rec16				record;

	rownum				integer;

	sortRec				record;
	sortNum				varchar(20);
	sortType			varchar(100);
	sortOrder			varchar(30);
	sortSQL				text;
BEGIN
	rownum=1;
	vRt:=''\n'';

	--Sort
	sortNum=substring(table_name from 8);
	sortNum=substring(sortNum from 0 for position(''_'' in sortNum));

	sortSQL := '' select sort_type,sort_order from oo_dimension where dimension_seq = '' || sortNum;
	for sortRec in execute sortSQL loop
		if sortRec.sort_type=''1''  then
			sortType:=''sort_col'';
		else
			sortType:=''to_number(sort_col,''''S999999999999999999999999999999.9999999999'''')'';
		end if;
		if sortRec.sort_order=''1''  then
			sortOrder:='' asc'';
		else
			sortOrder:='' desc'';
		end if;
	end loop;


	--time dimension
	if sortType is Null then
		sortType:=''key'';
	end if;
	if sortOrder is Null then
		sortOrder:='' asc'';
	end if;


	sql1:=           ''select *,0 as minusLevel from '' || table_name;
	if parentRec is null then
		sql1:=sql1 || '' where par_key is null ''|| vRt;
	else
		sql1:=sql1 || '' where par_key = '' || parentRec|| vRt;
	end if;
	sql1:=sql1 || '' order by '' || sortType || sortOrder || '' ,short_name'';

	for rec1 in execute sql1 loop
		ret.key				:= rec1.key;
		ret.par_key			:= rec1.par_key;
		ret.col_1			:= rec1.col_1;
		ret.col_2			:= rec1.col_2;
		ret.col_3			:= rec1.col_3;
		ret.col_4			:= rec1.col_4;
		ret.col_5			:= rec1.col_5;
		ret.col_6			:= rec1.col_6;
		ret.sort_col		:= rec1.sort_col;
		ret.code			:= rec1.code;
		ret.short_name		:= rec1.short_name;
		ret.long_name		:= rec1.long_name;
		ret.calc_text		:= rec1.calc_text;
		ret.time_date		:= rec1.time_date;
		ret.org_level		:= rec1.org_level;
		ret.cust_level		:= rec1.cust_level;
		ret.leaf_flg		:= rec1.leaf_flg;
		ret.kind_flg		:= rec1.kind_flg;
		ret.name_update_flg	:= rec1.name_update_flg;
		ret.min_val			:= rec1.min_val;
		ret.max_val			:= rec1.max_val;
		ret.level			:= 1;
		ret.rownum			:=rownum;
		if whereIn is null then
			RETURN NEXT ret;
			rownum:=rownum+1;
		else
			if position('',''||ret.key||'','' in whereIn)=0 then
				rec1.minusLevel=1;
			else
				rec1.minusLevel=0;
				RETURN NEXT ret;
				rownum:=rownum+1;
			end if;
		end if;
		sql2:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec1.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
		for rec2 in execute sql2 loop
			ret.key				:= rec2.key;
			ret.par_key			:= rec2.par_key;
			ret.col_1			:= rec2.col_1;
			ret.col_2			:= rec2.col_2;
			ret.col_3			:= rec2.col_3;
			ret.col_4			:= rec2.col_4;
			ret.col_5			:= rec2.col_5;
			ret.col_6			:= rec2.col_6;
			ret.sort_col		:= rec2.sort_col;
			ret.code			:= rec2.code;
			ret.short_name		:= rec2.short_name;
			ret.long_name		:= rec2.long_name;
			ret.calc_text		:= rec2.calc_text;
			ret.time_date		:= rec2.time_date;
			ret.org_level		:= rec2.org_level;
			ret.cust_level		:= rec2.cust_level;
			ret.leaf_flg		:= rec2.leaf_flg;
			ret.kind_flg		:= rec2.kind_flg;
			ret.name_update_flg	:= rec2.name_update_flg;
			ret.min_val			:= rec2.min_val;
			ret.max_val			:= rec2.max_val;
			ret.level			:= 2-rec1.minusLevel;
			ret.rownum			:=rownum;
			if whereIn is null then
				RETURN NEXT ret;
				rownum:=rownum+1;
			else
				if position('',''||ret.key||'','' in whereIn)=0 then
					rec2.minusLevel=1;
				else
					rec2.minusLevel=0;
					RETURN NEXT ret;
					rownum:=rownum+1;
				end if;
			end if;
			sql3:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec2.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
			for rec3 in execute sql3 loop
				ret.key				:= rec3.key;
				ret.par_key			:= rec3.par_key;
				ret.col_1			:= rec3.col_1;
				ret.col_2			:= rec3.col_2;
				ret.col_3			:= rec3.col_3;
				ret.col_4			:= rec3.col_4;
				ret.col_5			:= rec3.col_5;
				ret.col_6			:= rec3.col_6;
				ret.sort_col		:= rec3.sort_col;
				ret.code			:= rec3.code;
				ret.short_name		:= rec3.short_name;
				ret.long_name		:= rec3.long_name;
				ret.calc_text		:= rec3.calc_text;
				ret.time_date		:= rec3.time_date;
				ret.org_level		:= rec3.org_level;
				ret.cust_level		:= rec3.cust_level;
				ret.leaf_flg		:= rec3.leaf_flg;
				ret.kind_flg		:= rec3.kind_flg;
				ret.name_update_flg	:= rec3.name_update_flg;
				ret.min_val			:= rec3.min_val;
				ret.max_val			:= rec3.max_val;
				ret.level			:= 3-rec1.minusLevel-rec2.minusLevel;
				ret.rownum			:=rownum;
				if whereIn is null then
					RETURN NEXT ret;
					rownum:=rownum+1;
				else
					if position('',''||ret.key||'','' in whereIn)=0 then
						rec3.minusLevel=1;
					else
						rec3.minusLevel=0;
						RETURN NEXT ret;
						rownum:=rownum+1;
					end if;
				end if;
				sql4:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec3.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
				for rec4 in execute sql4 loop
					ret.key				:= rec4.key;
					ret.par_key			:= rec4.par_key;
					ret.col_1			:= rec4.col_1;
					ret.col_2			:= rec4.col_2;
					ret.col_3			:= rec4.col_3;
					ret.col_4			:= rec4.col_4;
					ret.col_5			:= rec4.col_5;
					ret.col_6			:= rec4.col_6;
					ret.sort_col		:= rec4.sort_col;
					ret.code			:= rec4.code;
					ret.short_name		:= rec4.short_name;
					ret.long_name		:= rec4.long_name;
					ret.calc_text		:= rec4.calc_text;
					ret.time_date		:= rec4.time_date;
					ret.org_level		:= rec4.org_level;
					ret.cust_level		:= rec4.cust_level;
					ret.leaf_flg		:= rec4.leaf_flg;
					ret.kind_flg		:= rec4.kind_flg;
					ret.name_update_flg	:= rec4.name_update_flg;
					ret.min_val			:= rec4.min_val;
					ret.max_val			:= rec4.max_val;
					ret.level			:= 4-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel;
					ret.rownum			:=rownum;
					if whereIn is null then
						RETURN NEXT ret;
						rownum:=rownum+1;
					else
						if position('',''||ret.key||'','' in whereIn)=0 then
							rec4.minusLevel=1;
						else
							rec4.minusLevel=0;
							RETURN NEXT ret;
							rownum:=rownum+1;
						end if;
					end if;
					sql5:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec4.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
					for rec5 in execute sql5 loop
						ret.key				:= rec5.key;
						ret.par_key			:= rec5.par_key;
						ret.col_1			:= rec5.col_1;
						ret.col_2			:= rec5.col_2;
						ret.col_3			:= rec5.col_3;
						ret.col_4			:= rec5.col_4;
						ret.col_5			:= rec5.col_5;
						ret.col_6			:= rec5.col_6;
						ret.sort_col		:= rec5.sort_col;
						ret.code			:= rec5.code;
						ret.short_name		:= rec5.short_name;
						ret.long_name		:= rec5.long_name;
						ret.calc_text		:= rec5.calc_text;
						ret.time_date		:= rec5.time_date;
						ret.org_level		:= rec5.org_level;
						ret.cust_level		:= rec5.cust_level;
						ret.leaf_flg		:= rec5.leaf_flg;
						ret.kind_flg		:= rec5.kind_flg;
						ret.name_update_flg	:= rec5.name_update_flg;
						ret.min_val			:= rec5.min_val;
						ret.max_val			:= rec5.max_val;
						ret.level			:= 5-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel;
						ret.rownum			:=rownum;
						if whereIn is null then
							RETURN NEXT ret;
							rownum:=rownum+1;
						else
							if position('',''||ret.key||'','' in whereIn)=0 then
								rec5.minusLevel=1;
							else
								rec5.minusLevel=0;
								RETURN NEXT ret;
								rownum:=rownum+1;
							end if;
						end if;
						sql6:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec5.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
						for rec6 in execute sql6 loop
							ret.key				:= rec6.key;
							ret.par_key			:= rec6.par_key;
							ret.col_1			:= rec6.col_1;
							ret.col_2			:= rec6.col_2;
							ret.col_3			:= rec6.col_3;
							ret.col_4			:= rec6.col_4;
							ret.col_5			:= rec6.col_5;
							ret.col_6			:= rec6.col_6;
							ret.sort_col		:= rec6.sort_col;
							ret.code			:= rec6.code;
							ret.short_name		:= rec6.short_name;
							ret.long_name		:= rec6.long_name;
							ret.calc_text		:= rec6.calc_text;
							ret.time_date		:= rec6.time_date;
							ret.org_level		:= rec6.org_level;
							ret.cust_level		:= rec6.cust_level;
							ret.leaf_flg		:= rec6.leaf_flg;
							ret.kind_flg		:= rec6.kind_flg;
							ret.name_update_flg	:= rec6.name_update_flg;
							ret.min_val			:= rec6.min_val;
							ret.max_val			:= rec6.max_val;
							ret.level			:= 6-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel;
							ret.rownum			:=rownum;
							if whereIn is null then
								RETURN NEXT ret;
								rownum:=rownum+1;
							else
								if position('',''||ret.key||'','' in whereIn)=0 then
									rec6.minusLevel=1;
								else
									rec6.minusLevel=0;
									RETURN NEXT ret;
									rownum:=rownum+1;
								end if;
							end if;
							sql7:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec6.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
							for rec7 in execute sql7 loop
								ret.key				:= rec7.key;
								ret.par_key			:= rec7.par_key;
								ret.col_1			:= rec7.col_1;
								ret.col_2			:= rec7.col_2;
								ret.col_3			:= rec7.col_3;
								ret.col_4			:= rec7.col_4;
								ret.col_5			:= rec7.col_5;
								ret.col_6			:= rec7.col_6;
								ret.sort_col		:= rec7.sort_col;
								ret.code			:= rec7.code;
								ret.short_name		:= rec7.short_name;
								ret.long_name		:= rec7.long_name;
								ret.calc_text		:= rec7.calc_text;
								ret.time_date		:= rec7.time_date;
								ret.org_level		:= rec7.org_level;
								ret.cust_level		:= rec7.cust_level;
								ret.leaf_flg		:= rec7.leaf_flg;
								ret.kind_flg		:= rec7.kind_flg;
								ret.name_update_flg	:= rec7.name_update_flg;
								ret.min_val			:= rec7.min_val;
								ret.max_val			:= rec7.max_val;
								ret.level			:= 7-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel;
								ret.rownum			:=rownum;
								if whereIn is null then
									RETURN NEXT ret;
									rownum:=rownum+1;
								else
									if position('',''||ret.key||'','' in whereIn)=0 then
										rec7.minusLevel=1;
									else
										rec7.minusLevel=0;
										RETURN NEXT ret;
										rownum:=rownum+1;
									end if;
								end if;
								sql8:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec7.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
								for rec8 in execute sql8 loop
									ret.key				:= rec8.key;
									ret.par_key			:= rec8.par_key;
									ret.col_1			:= rec8.col_1;
									ret.col_2			:= rec8.col_2;
									ret.col_3			:= rec8.col_3;
									ret.col_4			:= rec8.col_4;
									ret.col_5			:= rec8.col_5;
									ret.col_6			:= rec8.col_6;
									ret.sort_col		:= rec8.sort_col;
									ret.code			:= rec8.code;
									ret.short_name		:= rec8.short_name;
									ret.long_name		:= rec8.long_name;
									ret.calc_text		:= rec8.calc_text;
									ret.time_date		:= rec8.time_date;
									ret.org_level		:= rec8.org_level;
									ret.cust_level		:= rec8.cust_level;
									ret.leaf_flg		:= rec8.leaf_flg;
									ret.kind_flg		:= rec8.kind_flg;
									ret.name_update_flg	:= rec8.name_update_flg;
									ret.min_val			:= rec8.min_val;
									ret.max_val			:= rec8.max_val;
									ret.level			:= 8-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel;
									ret.rownum			:=rownum;
									if whereIn is null then
										RETURN NEXT ret;
										rownum:=rownum+1;
									else
										if position('',''||ret.key||'','' in whereIn)=0 then
											rec8.minusLevel=1;
										else
											rec8.minusLevel=0;
											RETURN NEXT ret;
											rownum:=rownum+1;
										end if;
									end if;
									sql9:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec8.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
									for rec9 in execute sql9 loop
										ret.key				:= rec9.key;
										ret.par_key			:= rec9.par_key;
										ret.col_1			:= rec9.col_1;
										ret.col_2			:= rec9.col_2;
										ret.col_3			:= rec9.col_3;
										ret.col_4			:= rec9.col_4;
										ret.col_5			:= rec9.col_5;
										ret.col_6			:= rec9.col_6;
										ret.sort_col		:= rec9.sort_col;
										ret.code			:= rec9.code;
										ret.short_name		:= rec9.short_name;
										ret.long_name		:= rec9.long_name;
										ret.calc_text		:= rec9.calc_text;
										ret.time_date		:= rec9.time_date;
										ret.org_level		:= rec9.org_level;
										ret.cust_level		:= rec9.cust_level;
										ret.leaf_flg		:= rec9.leaf_flg;
										ret.kind_flg		:= rec9.kind_flg;
										ret.name_update_flg	:= rec9.name_update_flg;
										ret.min_val			:= rec9.min_val;
										ret.max_val			:= rec9.max_val;
										ret.level			:= 9-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel;
										ret.rownum			:=rownum;
										if whereIn is null then
											RETURN NEXT ret;
											rownum:=rownum+1;
										else
											if position('',''||ret.key||'','' in whereIn)=0 then
												rec9.minusLevel=1;
											else
												rec9.minusLevel=0;
												RETURN NEXT ret;
												rownum:=rownum+1;
											end if;
										end if;
										sql10:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec9.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
										for rec10 in execute sql10 loop
											ret.key				:= rec10.key;
											ret.par_key			:= rec10.par_key;
											ret.col_1			:= rec10.col_1;
											ret.col_2			:= rec10.col_2;
											ret.col_3			:= rec10.col_3;
											ret.col_4			:= rec10.col_4;
											ret.col_5			:= rec10.col_5;
											ret.col_6			:= rec10.col_6;
											ret.sort_col		:= rec10.sort_col;
											ret.code			:= rec10.code;
											ret.short_name		:= rec10.short_name;
											ret.long_name		:= rec10.long_name;
											ret.calc_text		:= rec10.calc_text;
											ret.time_date		:= rec10.time_date;
											ret.org_level		:= rec10.org_level;
											ret.cust_level		:= rec10.cust_level;
											ret.leaf_flg		:= rec10.leaf_flg;
											ret.kind_flg		:= rec10.kind_flg;
											ret.name_update_flg	:= rec10.name_update_flg;
											ret.min_val			:= rec10.min_val;
											ret.max_val			:= rec10.max_val;
											ret.level			:= 10-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel;
											ret.rownum			:=rownum;
											if whereIn is null then
												RETURN NEXT ret;
												rownum:=rownum+1;
											else
												if position('',''||ret.key||'','' in whereIn)=0 then
													rec10.minusLevel=1;
												else
													rec10.minusLevel=0;
													RETURN NEXT ret;
													rownum:=rownum+1;
												end if;
											end if;
											sql11:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec10.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
											for rec11 in execute sql11 loop
												ret.key				:= rec11.key;
												ret.par_key			:= rec11.par_key;
												ret.col_1			:= rec11.col_1;
												ret.col_2			:= rec11.col_2;
												ret.col_3			:= rec11.col_3;
												ret.col_4			:= rec11.col_4;
												ret.col_5			:= rec11.col_5;
												ret.col_6			:= rec11.col_6;
												ret.sort_col		:= rec11.sort_col;
												ret.code			:= rec11.code;
												ret.short_name		:= rec11.short_name;
												ret.long_name		:= rec11.long_name;
												ret.calc_text		:= rec11.calc_text;
												ret.time_date		:= rec11.time_date;
												ret.org_level		:= rec11.org_level;
												ret.cust_level		:= rec11.cust_level;
												ret.leaf_flg		:= rec11.leaf_flg;
												ret.kind_flg		:= rec11.kind_flg;
												ret.name_update_flg	:= rec11.name_update_flg;
												ret.min_val			:= rec11.min_val;
												ret.max_val			:= rec11.max_val;
												ret.level			:= 11-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel;
												ret.rownum			:=rownum;
												if whereIn is null then
													RETURN NEXT ret;
													rownum:=rownum+1;
												else
													if position('',''||ret.key||'','' in whereIn)=0 then
														rec11.minusLevel=1;
													else
														rec11.minusLevel=0;
														RETURN NEXT ret;
														rownum:=rownum+1;
													end if;
												end if;
												sql12:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec11.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
												for rec12 in execute sql12 loop
													ret.key				:= rec12.key;
													ret.par_key			:= rec12.par_key;
													ret.col_1			:= rec12.col_1;
													ret.col_2			:= rec12.col_2;
													ret.col_3			:= rec12.col_3;
													ret.col_4			:= rec12.col_4;
													ret.col_5			:= rec12.col_5;
													ret.col_6			:= rec12.col_6;
													ret.sort_col		:= rec12.sort_col;
													ret.code			:= rec12.code;
													ret.short_name		:= rec12.short_name;
													ret.long_name		:= rec12.long_name;
													ret.calc_text		:= rec12.calc_text;
													ret.time_date		:= rec12.time_date;
													ret.org_level		:= rec12.org_level;
													ret.cust_level		:= rec12.cust_level;
													ret.leaf_flg		:= rec12.leaf_flg;
													ret.kind_flg		:= rec12.kind_flg;
													ret.name_update_flg	:= rec12.name_update_flg;
													ret.min_val			:= rec12.min_val;
													ret.max_val			:= rec12.max_val;
													ret.level			:= 12-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel;
													ret.rownum			:=rownum;
													if whereIn is null then
														RETURN NEXT ret;
														rownum:=rownum+1;
													else
														if position('',''||ret.key||'','' in whereIn)=0 then
															rec12.minusLevel=1;
														else
															rec12.minusLevel=0;
															RETURN NEXT ret;
															rownum:=rownum+1;
														end if;
													end if;
													sql13:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec12.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
													for rec13 in execute sql13 loop
														ret.key				:= rec13.key;
														ret.par_key			:= rec13.par_key;
														ret.col_1			:= rec13.col_1;
														ret.col_2			:= rec13.col_2;
														ret.col_3			:= rec13.col_3;
														ret.col_4			:= rec13.col_4;
														ret.col_5			:= rec13.col_5;
														ret.col_6			:= rec13.col_6;
														ret.sort_col		:= rec13.sort_col;
														ret.code			:= rec13.code;
														ret.short_name		:= rec13.short_name;
														ret.long_name		:= rec13.long_name;
														ret.calc_text		:= rec13.calc_text;
														ret.time_date		:= rec13.time_date;
														ret.org_level		:= rec13.org_level;
														ret.cust_level		:= rec13.cust_level;
														ret.leaf_flg		:= rec13.leaf_flg;
														ret.kind_flg		:= rec13.kind_flg;
														ret.name_update_flg	:= rec13.name_update_flg;
														ret.min_val			:= rec13.min_val;
														ret.max_val			:= rec13.max_val;
														ret.level			:= 13-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel;
														ret.rownum			:=rownum;
														if whereIn is null then
															RETURN NEXT ret;
															rownum:=rownum+1;
														else
															if position('',''||ret.key||'','' in whereIn)=0 then
																rec13.minusLevel=1;
															else
																rec13.minusLevel=0;
																RETURN NEXT ret;
																rownum:=rownum+1;
															end if;
														end if;
														sql14:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec13.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
														for rec14 in execute sql14 loop
															ret.key				:= rec14.key;
															ret.par_key			:= rec14.par_key;
															ret.col_1			:= rec14.col_1;
															ret.col_2			:= rec14.col_2;
															ret.col_3			:= rec14.col_3;
															ret.col_4			:= rec14.col_4;
															ret.col_5			:= rec14.col_5;
															ret.col_6			:= rec14.col_6;
															ret.sort_col		:= rec14.sort_col;
															ret.code			:= rec14.code;
															ret.short_name		:= rec14.short_name;
															ret.long_name		:= rec14.long_name;
															ret.calc_text		:= rec14.calc_text;
															ret.time_date		:= rec14.time_date;
															ret.org_level		:= rec14.org_level;
															ret.cust_level		:= rec14.cust_level;
															ret.leaf_flg		:= rec14.leaf_flg;
															ret.kind_flg		:= rec14.kind_flg;
															ret.name_update_flg	:= rec14.name_update_flg;
															ret.min_val			:= rec14.min_val;
															ret.max_val			:= rec14.max_val;
															ret.level			:= 14-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel;
															ret.rownum			:=rownum;
															if whereIn is null then
																RETURN NEXT ret;
																rownum:=rownum+1;
															else
																if position('',''||ret.key||'','' in whereIn)=0 then
																	rec14.minusLevel=1;
																else
																	rec14.minusLevel=0;
																	RETURN NEXT ret;
																	rownum:=rownum+1;
																end if;
															end if;
															sql15:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec14.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
															for rec15 in execute sql15 loop
																ret.key				:= rec15.key;
																ret.par_key			:= rec15.par_key;
																ret.col_1			:= rec15.col_1;
																ret.col_2			:= rec15.col_2;
																ret.col_3			:= rec15.col_3;
																ret.col_4			:= rec15.col_4;
																ret.col_5			:= rec15.col_5;
																ret.col_6			:= rec15.col_6;
																ret.sort_col		:= rec15.sort_col;
																ret.code			:= rec15.code;
																ret.short_name		:= rec15.short_name;
																ret.long_name		:= rec15.long_name;
																ret.calc_text		:= rec15.calc_text;
																ret.time_date		:= rec15.time_date;
																ret.org_level		:= rec15.org_level;
																ret.cust_level		:= rec15.cust_level;
																ret.leaf_flg		:= rec15.leaf_flg;
																ret.kind_flg		:= rec15.kind_flg;
																ret.name_update_flg	:= rec15.name_update_flg;
																ret.min_val			:= rec15.min_val;
																ret.max_val			:= rec15.max_val;
																ret.level			:= 15-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel-rec14.minusLevel;
																ret.rownum			:=rownum;
																if whereIn is null then
																	RETURN NEXT ret;
																	rownum:=rownum+1;
																else
																	if position('',''||ret.key||'','' in whereIn)=0 then
																		rec15.minusLevel=1;
																	else
																		rec15.minusLevel=0;
																		RETURN NEXT ret;
																		rownum:=rownum+1;
																	end if;
																end if;
																sql16:=''select *,0 as minusLevel from '' || table_name || '' where par_key = '' || rec15.key || '' and leaf_flg!=''''9'''' order by '' || sortType || sortOrder || '' ,short_name'';
																for rec16 in execute sql16 loop
																	ret.key				:= rec16.key;
																	ret.par_key			:= rec16.par_key;
																	ret.col_1			:= rec16.col_1;
																	ret.col_2			:= rec16.col_2;
																	ret.col_3			:= rec16.col_3;
																	ret.col_4			:= rec16.col_4;
																	ret.col_5			:= rec16.col_5;
																	ret.col_6			:= rec16.col_6;
																	ret.sort_col		:= rec16.sort_col;
																	ret.code			:= rec16.code;
																	ret.short_name		:= rec16.short_name;
																	ret.long_name		:= rec16.long_name;
																	ret.calc_text		:= rec16.calc_text;
																	ret.time_date		:= rec16.time_date;
																	ret.org_level		:= rec16.org_level;
																	ret.cust_level		:= rec16.cust_level;
																	ret.leaf_flg		:= rec16.leaf_flg;
																	ret.kind_flg		:= rec16.kind_flg;
																	ret.name_update_flg	:= rec16.name_update_flg;
																	ret.min_val			:= rec16.min_val;
																	ret.max_val			:= rec16.max_val;
																	ret.level			:= 16-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel-rec14.minusLevel-rec15.minusLevel;
																	ret.rownum			:=rownum;
																	if whereIn is null then
																		RETURN NEXT ret;
																		rownum:=rownum+1;
																	else
																		if position('',''||ret.key||'','' in whereIn)=0 then
																			rec16.minusLevel=1;
																		else
																			rec16.minusLevel=0;
																			RETURN NEXT ret;
																			rownum:=rownum+1;
																		end if;
																	end if;
																end loop;
															end loop;
														end loop;
													end loop;
												end loop;
											end loop;
										end loop;
									end loop;
								end loop;
							end loop;
						end loop;
					end loop;
				end loop;
			end loop;
		end loop;
	end loop;
	RETURN;
END;
' LANGUAGE 'plpgsql';
/

CREATE OR REPLACE FUNCTION %schema%.oo_report_tree(varchar(30),text,text) RETURNS SETOF oo_v_report AS '
DECLARE
	table_name		ALIAS FOR $1;
	parentRec		ALIAS FOR $2;
	whereIn			ALIAS FOR $3;

	ret 			oo_v_report%rowtype;

	sql1			text;
	sql2			text;
	sql3			text;
	sql4			text;
	sql5			text;
	sql6			text;
	sql7			text;
	sql8			text;
	sql9			text;
	sql10			text;
	sql11			text;
	sql12			text;
	sql13			text;
	sql14			text;
	sql15			text;
	sql16			text;

	vRt				varchar(10);

	rec1				record;
	rec2				record;
	rec3				record;
	rec4				record;
	rec5				record;
	rec6				record;
	rec7				record;
	rec8				record;
	rec9				record;
	rec10				record;
	rec11				record;
	rec12				record;
	rec13				record;
	rec14				record;
	rec15				record;
	rec16				record;
BEGIN
	vRt:=''\n'';
	sql1:=           ''select *,0 as minusLevel from '' || table_name;
	if parentRec is null then
		sql1:=sql1 || '' where par_id is null ''|| vRt;
	else
		sql1:=sql1 || '' where par_id = '' || parentRec|| vRt;
	end if;
	sql1:=sql1 || '' and report_owner_flg<>2'';
	sql1:=sql1 || '' order by kind_flg,report_name'';

	for rec1 in execute sql1 loop
		ret.report_id		:= rec1.report_id;
		ret.par_id			:= rec1.par_id;
		ret.report_name		:= rec1.report_name;
		ret.kind_flg		:= rec1.kind_flg;
		ret.report_type		:= rec1.report_type;
		ret.update_date		:= rec1.update_date;
		ret.level			:= 1;
		if whereIn is null then
			RETURN NEXT ret;
		else
			if position('',''||ret.report_id||'','' in whereIn)=0 then
				rec1.minusLevel=1;
			else
				rec1.minusLevel=0;
				RETURN NEXT ret;
			end if;
		end if;
		sql2:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec1.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
		for rec2 in execute sql2 loop
			ret.report_id		:= rec2.report_id;
			ret.par_id			:= rec2.par_id;
			ret.report_name		:= rec2.report_name;
			ret.kind_flg		:= rec2.kind_flg;
			ret.report_type		:= rec2.report_type;
			ret.update_date		:= rec2.update_date;
			ret.level			:= 2-rec1.minusLevel;
			if whereIn is null then
				RETURN NEXT ret;
			else
				if position('',''||ret.report_id||'','' in whereIn)=0 then
					rec2.minusLevel=1;
				else
					rec2.minusLevel=0;
					RETURN NEXT ret;
				end if;
			end if;
			sql3:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec2.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
			for rec3 in execute sql3 loop
				ret.report_id		:= rec3.report_id;
				ret.par_id			:= rec3.par_id;
				ret.report_name		:= rec3.report_name;
				ret.kind_flg		:= rec3.kind_flg;
				ret.report_type		:= rec3.report_type;
				ret.update_date		:= rec3.update_date;
				ret.level			:= 3-rec1.minusLevel-rec2.minusLevel;
				if whereIn is null then
					RETURN NEXT ret;
				else
					if position('',''||ret.report_id||'','' in whereIn)=0 then
						rec3.minusLevel=1;
					else
						rec3.minusLevel=0;
						RETURN NEXT ret;
					end if;
				end if;
				sql4:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec3.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
				for rec4 in execute sql4 loop
					ret.report_id		:= rec4.report_id;
					ret.par_id			:= rec4.par_id;
					ret.report_name		:= rec4.report_name;
					ret.kind_flg		:= rec4.kind_flg;
					ret.report_type		:= rec4.report_type;
					ret.update_date		:= rec4.update_date;
					ret.level			:= 4-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel;
					if whereIn is null then
						RETURN NEXT ret;
					else
						if position('',''||ret.report_id||'','' in whereIn)=0 then
							rec4.minusLevel=1;
						else
							rec4.minusLevel=0;
							RETURN NEXT ret;
						end if;
					end if;
					sql5:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec4.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
					for rec5 in execute sql5 loop
						ret.report_id		:= rec5.report_id;
						ret.par_id			:= rec5.par_id;
						ret.report_name		:= rec5.report_name;
						ret.kind_flg		:= rec5.kind_flg;
						ret.report_type		:= rec5.report_type;
						ret.update_date		:= rec5.update_date;
						ret.level			:= 5-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel;
						if whereIn is null then
							RETURN NEXT ret;
						else
							if position('',''||ret.report_id||'','' in whereIn)=0 then
								rec5.minusLevel=1;
							else
								rec5.minusLevel=0;
								RETURN NEXT ret;
							end if;
						end if;
						sql6:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec5.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
						for rec6 in execute sql6 loop
							ret.report_id		:= rec6.report_id;
							ret.par_id			:= rec6.par_id;
							ret.report_name		:= rec6.report_name;
							ret.kind_flg		:= rec6.kind_flg;
							ret.report_type		:= rec6.report_type;
							ret.update_date		:= rec6.update_date;
							ret.level			:= 6-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel;
							if whereIn is null then
								RETURN NEXT ret;
							else
								if position('',''||ret.report_id||'','' in whereIn)=0 then
									rec6.minusLevel=1;
								else
									rec6.minusLevel=0;
									RETURN NEXT ret;
								end if;
							end if;
							sql7:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec6.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
							for rec7 in execute sql7 loop
								ret.report_id		:= rec7.report_id;
								ret.par_id			:= rec7.par_id;
								ret.report_name		:= rec7.report_name;
								ret.kind_flg		:= rec7.kind_flg;
								ret.report_type		:= rec7.report_type;
								ret.update_date		:= rec7.update_date;
								ret.level			:= 7-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel;
								if whereIn is null then
									RETURN NEXT ret;
								else
									if position('',''||ret.report_id||'','' in whereIn)=0 then
										rec7.minusLevel=1;
									else
										rec7.minusLevel=0;
										RETURN NEXT ret;
									end if;
								end if;
								sql8:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec7.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
								for rec8 in execute sql8 loop
									ret.report_id		:= rec8.report_id;
									ret.par_id			:= rec8.par_id;
									ret.report_name		:= rec8.report_name;
									ret.kind_flg		:= rec8.kind_flg;
									ret.report_type		:= rec8.report_type;
									ret.update_date		:= rec8.update_date;
									ret.level			:= 8-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel;
									if whereIn is null then
										RETURN NEXT ret;
									else
										if position('',''||ret.report_id||'','' in whereIn)=0 then
											rec8.minusLevel=1;
										else
											rec8.minusLevel=0;
											RETURN NEXT ret;
										end if;
									end if;
									sql9:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec8.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
									for rec9 in execute sql9 loop
										ret.report_id		:= rec9.report_id;
										ret.par_id			:= rec9.par_id;
										ret.report_name		:= rec9.report_name;
										ret.kind_flg		:= rec9.kind_flg;
										ret.report_type		:= rec9.report_type;
										ret.update_date		:= rec9.update_date;
										ret.level			:= 9-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel;
										if whereIn is null then
											RETURN NEXT ret;
										else
											if position('',''||ret.report_id||'','' in whereIn)=0 then
												rec9.minusLevel=1;
											else
												rec9.minusLevel=0;
												RETURN NEXT ret;
											end if;
										end if;
										sql10:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec9.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
										for rec10 in execute sql10 loop
											ret.report_id		:= rec10.report_id;
											ret.par_id			:= rec10.par_id;
											ret.report_name		:= rec10.report_name;
											ret.kind_flg		:= rec10.kind_flg;
											ret.report_type		:= rec10.report_type;
											ret.update_date		:= rec10.update_date;
											ret.level			:= 10-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel;
											if whereIn is null then
												RETURN NEXT ret;
											else
												if position('',''||ret.report_id||'','' in whereIn)=0 then
													rec10.minusLevel=1;
												else
													rec10.minusLevel=0;
													RETURN NEXT ret;
												end if;
											end if;
											sql11:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec10.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
											for rec11 in execute sql11 loop
												ret.report_id		:= rec11.report_id;
												ret.par_id			:= rec11.par_id;
												ret.report_name		:= rec11.report_name;
												ret.kind_flg		:= rec11.kind_flg;
												ret.report_type		:= rec11.report_type;
												ret.update_date		:= rec11.update_date;
												ret.level			:= 11-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel;
												if whereIn is null then
													RETURN NEXT ret;
												else
													if position('',''||ret.report_id||'','' in whereIn)=0 then
														rec11.minusLevel=1;
													else
														rec11.minusLevel=0;
														RETURN NEXT ret;
													end if;
												end if;
												sql12:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec11.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
												for rec12 in execute sql12 loop
													ret.report_id		:= rec12.report_id;
													ret.par_id			:= rec12.par_id;
													ret.report_name		:= rec12.report_name;
													ret.kind_flg		:= rec12.kind_flg;
													ret.report_type		:= rec12.report_type;
													ret.update_date		:= rec12.update_date;
													ret.level			:= 12-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel;
													if whereIn is null then
														RETURN NEXT ret;
													else
														if position('',''||ret.report_id||'','' in whereIn)=0 then
															rec12.minusLevel=1;
														else
															rec12.minusLevel=0;
															RETURN NEXT ret;
														end if;
													end if;
													sql13:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec12.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
													for rec13 in execute sql13 loop
														ret.report_id		:= rec13.report_id;
														ret.par_id			:= rec13.par_id;
														ret.report_name		:= rec13.report_name;
														ret.kind_flg		:= rec13.kind_flg;
														ret.report_type		:= rec13.report_type;
														ret.update_date		:= rec13.update_date;
														ret.level			:= 13-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel;
														if whereIn is null then
															RETURN NEXT ret;
														else
															if position('',''||ret.report_id||'','' in whereIn)=0 then
																rec13.minusLevel=1;
															else
																rec13.minusLevel=0;
																RETURN NEXT ret;
															end if;
														end if;
														sql14:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec13.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
														for rec14 in execute sql14 loop
															ret.report_id		:= rec14.report_id;
															ret.par_id			:= rec14.par_id;
															ret.report_name		:= rec14.report_name;
															ret.kind_flg		:= rec14.kind_flg;
															ret.report_type		:= rec14.report_type;
															ret.update_date		:= rec14.update_date;
															ret.level			:= 14-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel;
															if whereIn is null then
																RETURN NEXT ret;
															else
																if position('',''||ret.report_id||'','' in whereIn)=0 then
																	rec14.minusLevel=1;
																else
																	rec14.minusLevel=0;
																	RETURN NEXT ret;
																end if;
															end if;
															sql15:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec14.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
															for rec15 in execute sql15 loop
																ret.report_id		:= rec15.report_id;
																ret.par_id			:= rec15.par_id;
																ret.report_name		:= rec15.report_name;
																ret.kind_flg		:= rec15.kind_flg;
																ret.report_type		:= rec15.report_type;
																ret.update_date		:= rec15.update_date;
																ret.level			:= 15-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel-rec14.minusLevel;
																if whereIn is null then
																	RETURN NEXT ret;
																else
																	if position('',''||ret.report_id||'','' in whereIn)=0 then
																		rec15.minusLevel=1;
																	else
																		rec15.minusLevel=0;
																		RETURN NEXT ret;
																	end if;
																end if;
																sql16:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec15.report_id || '' and report_owner_flg<>2 order by kind_flg,report_name'';
																for rec16 in execute sql16 loop
																	ret.report_id		:= rec16.report_id;
																	ret.par_id			:= rec16.par_id;
																	ret.report_name		:= rec16.report_name;
																	ret.kind_flg		:= rec16.kind_flg;
																	ret.report_type		:= rec16.report_type;
																	ret.update_date		:= rec16.update_date;
																	if whereIn is null then
																		RETURN NEXT ret;
																	else
																		if position('',''||ret.report_id||'','' in whereIn)=0 then
																			rec16.minusLevel=1;
																		else
																			rec16.minusLevel=0;
																			RETURN NEXT ret;
																		end if;
																	end if;
																end loop;
															end loop;
														end loop;
													end loop;
												end loop;
											end loop;
										end loop;
									end loop;
								end loop;
							end loop;
						end loop;
					end loop;
				end loop;
			end loop;
		end loop;
	end loop;
	RETURN;
END;
' LANGUAGE 'plpgsql';
/

CREATE OR REPLACE FUNCTION %schema%.oo_sec_func(integer,integer) RETURNS SETOF oo_v_group_report AS '
DECLARE
	user_id			ALIAS FOR $1;
	report_id		ALIAS FOR $2;

	ret 			oo_v_group_report%rowtype;
	sql				text;
	vRt				varchar(10);
	rec				record;

	retReference_report_id	integer;
	retExport_flg	varchar(1);

BEGIN
	vRt:=''\n'';
--	sql:=''select g.group_id,r.report_id,right_flg,save_flg,export_flg'';
--	sql:=sql || ''   from oo_v_user_group g '';
--	sql:=sql || ''  ,oo_v_group_report r '';
--	sql:=sql || ''  where g.group_id = r.group_id '';
--	sql:=sql || ''  and g.user_id = '' || user_id;
--	sql:=sql || ''  and r.report_id = '' || report_id;
--
--	for rec in execute sql loop
--		if rec.right_flg = ''1'' then
--			ret.right_flg		:= rec.right_flg;
--		end if;
--
--		if rec.export_flg = ''1'' then
--			ret.export_flg		:= rec.export_flg;
--		end if;
--	end loop;

	-----if ret.group_id is null and user_id = 1 then admin
	if user_id = 1 then
		ret.group_id		:= null;
		ret.report_id		:= report_id;
		ret.right_flg		:= 1;
		ret.export_flg		:= 1;
		RETURN next ret;
		return;
	end if;

	sql:=''select g.group_id'';
	sql:=sql || '',r.report_id'';
	sql:=sql || '',max(right_flg) as right_flg'';
	sql:=sql || '',max(export_flg) as export_flg'';
	sql:=sql || ''   from oo_v_user_group g '';
	sql:=sql || ''  ,oo_v_group_report r '';
	sql:=sql || ''  where g.group_id = r.group_id '';
	sql:=sql || ''  and g.user_id = '' || user_id;
	sql:=sql || ''  and r.report_id = '' || report_id;
	sql:=sql || ''  group by g.group_id,r.report_id'';

	for rec in execute sql loop
		ret.group_id		:= rec.group_id;
		ret.report_id		:= rec.report_id;
		ret.right_flg		:= rec.right_flg;
		ret.export_flg		:= rec.export_flg;
	end loop;

	-----if ret.group_id is null and belong to no group then null return
	sql:=''select count(*) as cnt from oo_v_user_group where user_id = '' || user_id;
	for rec in execute sql loop
		if rec.cnt = 0 then
			ret.group_id		:= null;
			ret.report_id		:= report_id;
			ret.right_flg		:= 0;
			ret.export_flg		:= 0;
			RETURN next ret;
			return;
		end if;
	end loop;

	-----if ret.group_id is null and belong to group then it is Personal Report or New Report
	if ret.group_id is null then
--		When new report is created , that record insert oo_v_group_report;
--		sql:=''select report_owner_flg from oo_v_report where report_id=''|| report_id;
--		for rec in execute sql loop
--			if rec.report_owner_flg=1 then --New Report
--				ret.group_id		:= null;
--				ret.report_id		:= report_id;
--				ret.right_flg		:= 1;
--				ret.export_flg		:= 1;
--				RETURN next ret;
--				return;
--			end if;
--		end loop;

		--else Personal Report
		ret.group_id		:= 0;
		ret.report_id		:= report_id;
		ret.right_flg		:= 1;

		--personal report export_flg depends on reference report export_flg
		sql:=''select reference_report_id from oo_v_report where report_id=''|| report_id;
		for rec in execute sql loop
			retReference_report_id:=rec.reference_report_id;
		end loop;

		if retReference_report_id is null then
			ret.export_flg:=0;
		else
			sql:=''select export_flg from %schema%.oo_sec_func(''||user_id||'',''||retReference_report_id||'')'';
			for rec in execute sql loop
				ret.export_flg:=rec.export_flg;
			end loop;
		end if;
	end if;

	RETURN next ret;
	return;
END;
' LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_report_tree(varchar(30),text,text,integer,varchar(1)) RETURNS SETOF oo_v_report AS '
DECLARE
	table_name		ALIAS FOR $1;
	parentRec		ALIAS FOR $2;
	whereIn			ALIAS FOR $3;
	user_id			ALIAS FOR $4;
	scope_kind_flg	ALIAS FOR $5;

	ret 			oo_v_report%rowtype;

	sql1			text;
	sql2			text;
	sql3			text;
	sql4			text;
	sql5			text;
	sql6			text;
	sql7			text;
	sql8			text;
	sql9			text;
	sql10			text;
	sql11			text;
	sql12			text;
	sql13			text;
	sql14			text;
	sql15			text;
	sql16			text;

	vRt				varchar(10);

	rec1				record;
	rec2				record;
	rec3				record;
	rec4				record;
	rec5				record;
	rec6				record;
	rec7				record;
	rec8				record;
	rec9				record;
	rec10				record;
	rec11				record;
	rec12				record;
	rec13				record;
	rec14				record;
	rec15				record;
	rec16				record;

	vRight_flg			char(1);
	scope_kind_int		integer;

BEGIN
	if scope_kind_flg=''0'' then
		scope_kind_int:=0;
	else
		scope_kind_int:=user_id;
	end if;

	vRt:=''\n'';
	sql1:=           ''select *,0 as minusLevel from '' || table_name;
	if parentRec is null then
		sql1:=sql1 || '' where par_id is null ''|| vRt;
	else
		sql1:=sql1 || '' where par_id = '' || parentRec|| vRt;
	end if;
	sql1:=sql1 || '' and user_id = '' || scope_kind_int || vRt;
	sql1:=sql1 || '' order by kind_flg,report_name'';

	for rec1 in execute sql1 loop
		ret.report_id		:= rec1.report_id;
		ret.par_id			:= rec1.par_id;
		ret.report_name		:= rec1.report_name;
		ret.kind_flg		:= rec1.kind_flg;
		ret.report_type		:= rec1.report_type;
		ret.update_date		:= rec1.update_date;
		ret.level			:= 1;

		select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
		if vRight_flg=''1'' then
			if whereIn is null then
				RETURN NEXT ret;
			else
				if position('',''||ret.report_id||'','' in whereIn)=0 then
					rec1.minusLevel=1;
				else
					rec1.minusLevel=0;
					RETURN NEXT ret;
				end if;
			end if;
		else--if no right then under all folders and reports can not be seen.
			rec1.report_id:=0;
		end if;
		sql2:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec1.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
		for rec2 in execute sql2 loop
			ret.report_id		:= rec2.report_id;
			ret.par_id			:= rec2.par_id;
			ret.report_name		:= rec2.report_name;
			ret.kind_flg		:= rec2.kind_flg;
			ret.report_type		:= rec2.report_type;
			ret.update_date		:= rec2.update_date;
			ret.level			:= 2-rec1.minusLevel;
			select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
			if vRight_flg=''1'' then
				if whereIn is null then
					RETURN NEXT ret;
				else
					if position('',''||ret.report_id||'','' in whereIn)=0 then
						rec2.minusLevel=1;
					else
						rec2.minusLevel=0;
						RETURN NEXT ret;
					end if;
				end if;
			else
				rec2.report_id:=0;
			end if;
			sql3:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec2.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
			for rec3 in execute sql3 loop
				ret.report_id		:= rec3.report_id;
				ret.par_id			:= rec3.par_id;
				ret.report_name		:= rec3.report_name;
				ret.kind_flg		:= rec3.kind_flg;
				ret.report_type		:= rec3.report_type;
				ret.update_date		:= rec3.update_date;
				ret.level			:= 3-rec1.minusLevel-rec2.minusLevel;
				select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
				if vRight_flg=''1'' then
					if whereIn is null then
						RETURN NEXT ret;
					else
						if position('',''||ret.report_id||'','' in whereIn)=0 then
							rec3.minusLevel=1;
						else
							rec3.minusLevel=0;
							RETURN NEXT ret;
						end if;
					end if;
				else
					rec3.report_id:=0;
				end if;
				sql4:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec3.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
				for rec4 in execute sql4 loop
					ret.report_id		:= rec4.report_id;
					ret.par_id			:= rec4.par_id;
					ret.report_name		:= rec4.report_name;
					ret.kind_flg		:= rec4.kind_flg;
					ret.report_type		:= rec4.report_type;
					ret.update_date		:= rec4.update_date;
					ret.level			:= 4-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel;
					select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
					if vRight_flg=''1'' then
						if whereIn is null then
							RETURN NEXT ret;
						else
							if position('',''||ret.report_id||'','' in whereIn)=0 then
								rec4.minusLevel=1;
							else
								rec4.minusLevel=0;
								RETURN NEXT ret;
							end if;
						end if;
					else
						rec4.report_id:=0;
					end if;
					sql5:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec4.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
					for rec5 in execute sql5 loop
						ret.report_id		:= rec5.report_id;
						ret.par_id			:= rec5.par_id;
						ret.report_name		:= rec5.report_name;
						ret.kind_flg		:= rec5.kind_flg;
						ret.report_type		:= rec5.report_type;
						ret.update_date		:= rec5.update_date;
						ret.level			:= 5-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel;
						select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
						if vRight_flg=''1'' then
							if whereIn is null then
								RETURN NEXT ret;
							else
								if position('',''||ret.report_id||'','' in whereIn)=0 then
									rec5.minusLevel=1;
								else
									rec5.minusLevel=0;
									RETURN NEXT ret;
								end if;
							end if;
						else
							rec5.report_id:=0;
						end if;
						sql6:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec5.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
						for rec6 in execute sql6 loop
							ret.report_id		:= rec6.report_id;
							ret.par_id			:= rec6.par_id;
							ret.report_name		:= rec6.report_name;
							ret.kind_flg		:= rec6.kind_flg;
							ret.report_type		:= rec6.report_type;
							ret.update_date		:= rec6.update_date;
							ret.level			:= 6-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel;
							select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
							if vRight_flg=''1'' then
								if whereIn is null then
									RETURN NEXT ret;
								else
									if position('',''||ret.report_id||'','' in whereIn)=0 then
										rec6.minusLevel=1;
									else
										rec6.minusLevel=0;
										RETURN NEXT ret;
									end if;
								end if;
							else
								rec6.report_id:=0;
							end if;
							sql7:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec6.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
							for rec7 in execute sql7 loop
								ret.report_id		:= rec7.report_id;
								ret.par_id			:= rec7.par_id;
								ret.report_name		:= rec7.report_name;
								ret.kind_flg		:= rec7.kind_flg;
								ret.report_type		:= rec7.report_type;
								ret.update_date		:= rec7.update_date;
								ret.level			:= 7-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel;
								select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
								if vRight_flg=''1'' then
									if whereIn is null then
										RETURN NEXT ret;
									else
										if position('',''||ret.report_id||'','' in whereIn)=0 then
											rec7.minusLevel=1;
										else
											rec7.minusLevel=0;
											RETURN NEXT ret;
										end if;
									end if;
								else
									rec7.report_id:=0;
								end if;
								sql8:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec7.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
								for rec8 in execute sql8 loop
									ret.report_id		:= rec8.report_id;
									ret.par_id			:= rec8.par_id;
									ret.report_name		:= rec8.report_name;
									ret.kind_flg		:= rec8.kind_flg;
									ret.report_type		:= rec8.report_type;
									ret.update_date		:= rec8.update_date;
									ret.level			:= 8-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel;
									select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
									if vRight_flg=''1'' then
										if whereIn is null then
											RETURN NEXT ret;
										else
											if position('',''||ret.report_id||'','' in whereIn)=0 then
												rec8.minusLevel=1;
											else
												rec8.minusLevel=0;
												RETURN NEXT ret;
											end if;
										end if;
									else
										rec8.report_id:=0;
									end if;
									sql9:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec8.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
									for rec9 in execute sql9 loop
										ret.report_id		:= rec9.report_id;
										ret.par_id			:= rec9.par_id;
										ret.report_name		:= rec9.report_name;
										ret.kind_flg		:= rec9.kind_flg;
										ret.report_type		:= rec9.report_type;
										ret.update_date		:= rec9.update_date;
										ret.level			:= 9-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel;
										select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
										if vRight_flg=''1'' then
											if whereIn is null then
												RETURN NEXT ret;
											else
												if position('',''||ret.report_id||'','' in whereIn)=0 then
													rec9.minusLevel=1;
												else
													rec9.minusLevel=0;
													RETURN NEXT ret;
												end if;
											end if;
										else
											rec9.report_id:=0;
										end if;
										sql10:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec9.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
										for rec10 in execute sql10 loop
											ret.report_id		:= rec10.report_id;
											ret.par_id			:= rec10.par_id;
											ret.report_name		:= rec10.report_name;
											ret.kind_flg		:= rec10.kind_flg;
											ret.report_type		:= rec10.report_type;
											ret.update_date		:= rec10.update_date;
											ret.level			:= 10-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel;
											select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
											if vRight_flg=''1'' then
												if whereIn is null then
													RETURN NEXT ret;
												else
													if position('',''||ret.report_id||'','' in whereIn)=0 then
														rec10.minusLevel=1;
													else
														rec10.minusLevel=0;
														RETURN NEXT ret;
													end if;
												end if;
											else
												rec10.report_id:=0;
											end if;
											sql11:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec10.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
											for rec11 in execute sql11 loop
												ret.report_id		:= rec11.report_id;
												ret.par_id			:= rec11.par_id;
												ret.report_name		:= rec11.report_name;
												ret.kind_flg		:= rec11.kind_flg;
												ret.report_type		:= rec11.report_type;
												ret.update_date		:= rec11.update_date;
												ret.level			:= 11-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel;
												select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
												if vRight_flg=''1'' then
													if whereIn is null then
														RETURN NEXT ret;
													else
														if position('',''||ret.report_id||'','' in whereIn)=0 then
															rec11.minusLevel=1;
														else
															rec11.minusLevel=0;
															RETURN NEXT ret;
														end if;
													end if;
												else
													rec11.report_id:=0;
												end if;
												sql12:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec11.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
												for rec12 in execute sql12 loop
													ret.report_id		:= rec12.report_id;
													ret.par_id			:= rec12.par_id;
													ret.report_name		:= rec12.report_name;
													ret.kind_flg		:= rec12.kind_flg;
													ret.report_type		:= rec12.report_type;
													ret.update_date		:= rec12.update_date;
													ret.level			:= 12-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel;
													select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
													if vRight_flg=''1'' then
														if whereIn is null then
															RETURN NEXT ret;
														else
															if position('',''||ret.report_id||'','' in whereIn)=0 then
																rec12.minusLevel=1;
															else
																rec12.minusLevel=0;
																RETURN NEXT ret;
															end if;
														end if;
													else
														rec12.report_id:=0;
													end if;
													sql13:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec12.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
													for rec13 in execute sql13 loop
														ret.report_id		:= rec13.report_id;
														ret.par_id			:= rec13.par_id;
														ret.report_name		:= rec13.report_name;
														ret.kind_flg		:= rec13.kind_flg;
														ret.report_type		:= rec13.report_type;
														ret.update_date		:= rec13.update_date;
														ret.level			:= 13-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel;
														select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
														if vRight_flg=''1'' then
															if whereIn is null then
																RETURN NEXT ret;
															else
																if position('',''||ret.report_id||'','' in whereIn)=0 then
																	rec13.minusLevel=1;
																else
																	rec13.minusLevel=0;
																	RETURN NEXT ret;
																end if;
															end if;
														else
															rec13.report_id:=0;
														end if;
														sql14:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec13.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
														for rec14 in execute sql14 loop
															ret.report_id		:= rec14.report_id;
															ret.par_id			:= rec14.par_id;
															ret.report_name		:= rec14.report_name;
															ret.kind_flg		:= rec14.kind_flg;
															ret.report_type		:= rec14.report_type;
															ret.update_date		:= rec14.update_date;
															ret.level			:= 14-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel;
															select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
															if vRight_flg=''1'' then
																if whereIn is null then
																	RETURN NEXT ret;
																else
																	if position('',''||ret.report_id||'','' in whereIn)=0 then
																		rec14.minusLevel=1;
																	else
																		rec14.minusLevel=0;
																		RETURN NEXT ret;
																	end if;
																end if;
															else
																rec14.report_id:=0;
															end if;
															sql15:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec14.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
															for rec15 in execute sql15 loop
																ret.report_id		:= rec15.report_id;
																ret.par_id			:= rec15.par_id;
																ret.report_name		:= rec15.report_name;
																ret.kind_flg		:= rec15.kind_flg;
																ret.report_type		:= rec15.report_type;
																ret.update_date		:= rec15.update_date;
																ret.level			:= 15-rec1.minusLevel-rec2.minusLevel-rec3.minusLevel-rec4.minusLevel-rec5.minusLevel-rec6.minusLevel-rec7.minusLevel-rec8.minusLevel-rec9.minusLevel-rec10.minusLevel-rec11.minusLevel-rec12.minusLevel-rec13.minusLevel-rec14.minusLevel;
																select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
																if vRight_flg=''1'' then
																	if whereIn is null then
																		RETURN NEXT ret;
																	else
																		if position('',''||ret.report_id||'','' in whereIn)=0 then
																			rec15.minusLevel=1;
																		else
																			rec15.minusLevel=0;
																			RETURN NEXT ret;
																		end if;
																	end if;
																else
																	rec15.report_id:=0;
																end if;
																sql16:=''select *,0 as minusLevel from '' || table_name || '' where par_id = '' || rec15.report_id || '' and user_id = '' || scope_kind_int || '' order by kind_flg,report_name'';
																for rec16 in execute sql16 loop
																	ret.report_id		:= rec16.report_id;
																	ret.par_id			:= rec16.par_id;
																	ret.report_name		:= rec16.report_name;
																	ret.kind_flg		:= rec16.kind_flg;
																	ret.report_type		:= rec16.report_type;
																	ret.update_date		:= rec16.update_date;
																	select into vRight_flg right_flg from oo_sec_func(user_id,ret.report_id);
																	if vRight_flg=''1'' then
																		if whereIn is null then
																			RETURN NEXT ret;
																		else
																			if position('',''||ret.report_id||'','' in whereIn)=0 then
																				rec16.minusLevel=1;
																			else
																				rec16.minusLevel=0;
																				RETURN NEXT ret;
																			end if;
																		end if;
																	else
																		rec16.report_id:=0;
																	end if;

																end loop;
															end loop;
														end loop;
													end loop;
												end loop;
											end loop;
										end loop;
									end loop;
								end loop;
							end loop;
						end loop;
					end loop;
				end loop;
			end loop;
		end loop;
	end loop;
	RETURN;
END;
' LANGUAGE 'plpgsql';
/

CREATE FUNCTION %schema%.oo_fun_mlink(integer) RETURNS text AS '
DECLARE
	vMeasure_seq				ALIAS FOR $1;

	vConcat_DimSeq	text;
	vComma varchar(1);

	rec						record;

	cu cursor for 
		select dimension_seq from oo_measure_link
		where measure_seq = vMeasure_seq
		order by dimension_seq;

BEGIN
	vConcat_DimSeq:='''';
	vComma:='''';

	open cu;
	loop
		fetch cu into rec;
		if not found then
			exit;
		end if;
		vConcat_DimSeq:= vConcat_DimSeq || vComma || rec.dimension_seq;
		vComma:='','';
	end loop;
	close cu;

	return vConcat_DimSeq;
END;
'LANGUAGE 'plpgsql';
/


CREATE FUNCTION %schema%.oo_fun_columnList(varchar,varchar) RETURNS text AS '
DECLARE
	vTableName				ALIAS FOR $1;--
	vSchemaName				ALIAS FOR $2;--
	vLowTableName			varchar;
	vLowSchemaName			varchar;
	vComma					varchar(1);
	retText					text;
	rec				record;

	cu cursor for 
		SELECT
		    pg_attribute.attnum         AS attnum,
		    pg_class.relname            AS table_name,
		    pg_attribute.attname        AS column_name,
		    pg_attribute.atttypid       AS atttypid,
		    pg_type.typname             AS typename,
		    case
		        when pg_attribute.atttypmod=-1            then 0
		        when pg_type.typname=''bpchar''           then  pg_attribute.atttypmod-4
		        when pg_type.typname=''varchar''          then  pg_attribute.atttypmod-4
		        when pg_type.typname=''numeric''          then (pg_attribute.atttypmod-4) / 65536
		        when pg_type.typname=''decimal''          then (pg_attribute.atttypmod-4) / 65536
		        when pg_type.typname=''date''             then 10
		        when pg_type.typname=''time''             then  8
		        when pg_type.typname=''timestamp''        then 19
		        when pg_type.typname=''bool''             then 1
		        end                     AS size,
		    case
		        when pg_type.typname=''numeric''          then ((pg_attribute.atttypmod-4) % 65536)
		        when pg_type.typname=''decimal''          then ((pg_attribute.atttypmod-4) % 65536)
		        end                     AS decimal_point,
		    pg_attribute.attnotnull     AS attnotnull,
		    pg_class.relacl             AS relacl,
		    pg_attribute.atthasdef      AS atthasdef
		FROM    pg_class,    pg_type,    pg_attribute  ,pg_namespace
		WHERE
		        pg_attribute.attrelid   = pg_class.oid
		AND     pg_type.oid             = pg_attribute.atttypid
		AND     pg_class.oid            = pg_attribute.attrelid
		AND     pg_namespace.oid        = pg_class.relnamespace
		AND     pg_attribute.attnum     >= 0
		AND     pg_class.relkind        in (''r'',''v'')
		AND     pg_class.relname        LIKE  vLowTableName
		AND     pg_namespace.nspname    LIKE  vLowSchemaName
		ORDER BY 
		    pg_class.relname,
		    pg_attribute.attnum;

BEGIN
	vLowTableName:=lower(vTableName);
	vLowSchemaName:=lower(vSchemaName);
	retText:='''';
	vComma:='''';
	open cu;
	loop
		fetch cu into rec;
		if not found then
			close cu;
			exit;
		end if;
		if coalesce(rec.size,''0'')=0 then
			retText:= retText || vComma || rec.column_name || '' '' || rec.typename || '' '' || '' '';
		else
			retText:= retText || vComma || rec.column_name || '' '' || rec.typename || '' '' || rec.size;
		end if;
		vComma:='','';
	end loop;

	RETURN retText;
END;
'LANGUAGE 'plpgsql';
/


CREATE FUNCTION %schema%.oo_fun_measure(integer) RETURNS SETOF oo_level AS '
DECLARE
	vUser_seq				ALIAS FOR $1;--

	ret				oo_level%rowtype;
	rec				record;
	rec2			record;
	sql				text;

	cu cursor for 
		select dimension_seq,name from oo_dimension
		where user_seq = vUser_seq
		order by dimension_seq;

BEGIN
	open cu;
	loop
		fetch cu into rec;
		if not found then
			exit;
		end if;

		sql:=''select * from oo_level where dimension_seq = '' || rec.dimension_seq || '' order by level_no desc'';
		for rec2 in execute sql loop
			ret.level_seq     := rec2.level_seq     ;
			ret.dimension_seq := rec2.dimension_seq ;
			ret.level_no      := rec2.level_no      ;
			ret.name          := rec2.name          ;
			ret.comment       := rec.name       ;-------Dimension name
			ret.table_name    := rec2.table_name    ;
			ret.long_name_col := rec2.long_name_col ;
			ret.short_name_col:= rec2.short_name_col;
			ret.sort_col      := rec2.sort_col      ;
			ret.key_col1      := rec2.key_col1      ;
			ret.key_col2      := rec2.key_col2      ;
			ret.key_col3      := rec2.key_col3      ;
			ret.key_col4      := rec2.key_col4      ;
			ret.key_col5      := rec2.key_col5      ;
			ret.link_col1     := rec2.link_col1     ;
			ret.link_col2     := rec2.link_col2     ;
			ret.link_col3     := rec2.link_col3     ;
			ret.link_col4     := rec2.link_col4     ;
			ret.link_col5     := rec2.link_col5     ;
			ret.where_clause  := rec2.where_clause  ;

			RETURN NEXT ret;
			exit;
		end loop;
	end loop;
	close cu;

	return;
END;
'LANGUAGE 'plpgsql';
/

CREATE FUNCTION %schema%.oo_dim_parts(integer,integer) RETURNS text AS '
DECLARE

	vDIMENSION_SEQ			ALIAS FOR $1;
	vPART_SEQ				ALIAS FOR $2;

	vSQL					TEXT;
	rec 					record;
	recCnt 					record;
	vRt						varchar(10);
	vAdd_member_flg			varchar(1);
	vRename_member_flg		varchar(1);
	vDelete_member_flg		varchar(1);


BEGIN
	vRt:=''\n'';

	if vPART_SEQ = ''1'' then
		return ''standard parts'';
	end if;

	select into vAdd_member_flg,vRename_member_flg,vDelete_member_flg 
				 Add_member_flg, Rename_member_flg, Delete_member_flg
		from oo_dimension_part 
		where dimension_seq=vDIMENSION_SEQ
		and part_seq=vPART_SEQ;

	if vDelete_member_flg = ''1'' then
		execute ''update oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '' set org_level=-1 where org_level != 0'';
	end if;

	for rec in execute ''select * from oo_dim_'' || vDIMENSION_SEQ || ''_1 where org_level !=0'' loop
		if vAdd_member_flg = ''1'' then
			vSQL:=''select count(*) as cnt from oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ;
			vSQL:=vSQL || '' where key='' || rec.key;
			for recCnt in execute vSQL loop
				if recCnt.cnt=0 then
					vSQL := ''insert into oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''';
					vSQL := vSQL || '' values(''|| rec.key || '''' || vRt;
					vSQL := vSQL || '','' ||     rec.par_key || '''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.col_1,'''') || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.col_2,'''') || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.col_3,'''') || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.col_4,'''') || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.col_5,'''') || '''''''' || vRt;
					vSQL := vSQL || '',null'' || vRt;----col_6
					vSQL := vSQL || '','''''' || coalesce(rec.sort_col,'''') || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.code,'''')            || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.short_name,'''')      || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.long_name,'''')       || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.calc_text,'''')       || '''''''' || vRt;
					vSQL := vSQL || '',null'' || vRt;----time_date
					vSQL := vSQL || '',''     || coalesce(rec.org_level,''0'')       || '''' || vRt;
					vSQL := vSQL || '',''     || coalesce(rec.cust_level,''0'')      || '''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.leaf_flg,'''')        || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.kind_flg,'''')        || '''''''' || vRt;
					vSQL := vSQL || '','''''' || coalesce(rec.name_update_flg,'''') || '''''''' || vRt;
					vSQL := vSQL || '',null'' || vRt;---min_Val
					vSQL := vSQL || '',null)'';----max_Val
--return vSQL;
					execute vSQL;
				end if;
			end loop;
		end if;

		if vRename_member_flg = ''1'' then
			vSQL := ''update oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''' || vRt;
			vSQL := vSQL || '' set short_name='''''' || rec.short_name || '''''''' ||vRt;
			vSQL := vSQL || '' ,   long_name='''''' || rec.long_name || '''''''' ||vRt;
			vSQL := vSQL || '' where key = ''||rec.key || vRt;
--return vSQL;
			execute vSQL;
		end if;

		if vDelete_member_flg = ''1'' then
			vSQL := ''update oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''' || vRt;
			vSQL := vSQL || '' set org_level='' || rec.org_level || vRt;
			vSQL := vSQL || '' where key = ''||rec.key || vRt;
			execute vSQL;
		end if;

	end loop;

	if vDelete_member_flg = ''1'' then
		vSQL := ''delete from oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''' || vRt;
		vSQL := vSQL || '' where org_level=-1 '';
		execute vSQL;

		--if deleted member that has child records then
		--their child records deleted
		vSQL := ''delete from oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''' || vRt;
		vSQL := vSQL || '' where key not in('';
		vSQL := vSQL || '' select key from oo_dim_tree(''''oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ || '''''',null,null))'';
		execute vSQL;
	end if;

	return vSQL;
END;
'LANGUAGE 'plpgsql';
/


CREATE or replace FUNCTION %schema%.oo_dim_level_adjust(integer,integer) RETURNS text AS '
DECLARE

	vDIMENSION_SEQ			ALIAS FOR $1;
	vPART_SEQ				ALIAS FOR $2;

	vSQL					TEXT;
	rec 					record;
	rec2 					record;

	vRt						varchar(10);
	vTableName				varchar(50);
	vCnt					integer;
	vLeaf_flg				char(1);

BEGIN
	vRt:=''\n'';
	vLeaf_flg:=''0'';
	vTableName:=''oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ;

	for rec in execute ''select key,level from oo_dim_tree('''''' || vTableName || '''''',null,null)'' loop
		vSQL:=''select count(*) as cnt from '' || vTableName || '' where par_key= '' || rec.key;
		for rec2 in execute vSQL loop
			if rec2.cnt = 0 then
				vLeaf_flg:=''1'';
			else
				vLeaf_flg:=''0'';
			end if;
		end loop;

		vSQL:=''update '' || vTableName || '' set cust_level = '' || rec.level || '',leaf_flg = '' || vLeaf_flg || '' where key = ''|| rec.key;
		execute vSQL;
	end loop;

	return vSQL;
END;
'LANGUAGE 'plpgsql';
/


CREATE or replace FUNCTION %schema%.oo_dim_level_adjust(integer,integer,varchar(50),varchar(50)) RETURNS text AS '
DECLARE
	vDIMENSION_SEQ			ALIAS FOR $1;
	vPART_SEQ				ALIAS FOR $2;

	vColum_Name				ALIAS FOR $3;
	vDelete_Name			ALIAS FOR $4;

	vSQL					TEXT;
	rec 					record;
	rec2 					record;

	vRt						varchar(10);
	vTableName				varchar(50);
	vCnt					integer;
	vLeaf_flg				char(1);

	preCol_1				varchar(50);
	preCol_2				varchar(50);
	preCol_3				varchar(50);
	preCol_4				varchar(50);
	preCol_5				varchar(50);
	preCol_6				varchar(50);
	preKey					integer;
	preParKey				integer;

BEGIN
	vRt:=''\n'';
	vLeaf_flg:=''0'';
	vTableName:=''oo_dim_'' || vDIMENSION_SEQ || ''_'' || vPART_SEQ;

	--親と子のコードが同じ場合に削除する（equal,equal）
	if vColum_Name=''equal'' and vDelete_Name=''equal'' then
		preCol_1:=null;
		preCol_2:=null;
		preCol_3:=null;
		preCol_4:=null;
		preCol_5:=null;
		preCol_6:=null;
		preKey:=null;
		preParKey:=null;
		for rec in execute ''select * from oo_dim_tree('''''' || vTableName || '''''',null,null)'' loop
			if preCol_1=rec.col_1 then --- and preCol_2=rec.col_2 and preCol_3=rec.col_3 and preCol_4=rec.col_4 and preCol_5=rec.col_5 and preCol_6=rec.col_6 then
				if coalesce(preParKey,0)=0 then
					vSQL:=''update '' || vTableName || '' set par_key = null where par_key=''|| preKey;
				else
					vSQL:=''update '' || vTableName || '' set par_key=''|| preParKey ||'' where par_key=''|| preKey;
				end if;
				execute vSQL;

				vSQL:=''delete from '' || vTableName || '' where key=''|| preKey;
				execute vSQL;
				preKey:=rec.key;
--				preParKey:=preParKey;------rec.par_keyをpreParKeyでUpdateするため同じもの
			else
				preKey:=rec.key;
				preParKey:=rec.par_key;
			end if;

			preCol_1:=rec.col_1;
			preCol_2:=rec.col_2;
			preCol_3:=rec.col_3;
			preCol_4:=rec.col_4;
			preCol_5:=rec.col_5;
			preCol_6:=rec.col_6;
		end loop;
	else
		------Delete------   difference level hierarchy
		vSQL:=''select key,par_key from '' || vTableName || '' where '' || vColum_Name || '' = '' || vDelete_Name;
		vSQL:=vSQL||'' order by cust_level'';
		for rec in execute vSQL loop
			if coalesce(rec.par_key,0)=0 then
				vSQL:=''update '' || vTableName || '' set par_key = null where par_key=''|| rec.key;
			else
				vSQL:=''update '' || vTableName || '' set par_key=''|| rec.par_key ||'' where par_key=''|| rec.key;
			end if;
			execute vSQL;

			vSQL:=''delete from '' || vTableName || '' where key=''|| rec.key;
			execute vSQL;
		end loop;
	end if;

	for rec in execute ''select key,level from oo_dim_tree('''''' || vTableName || '''''',null,null)'' loop
		vSQL:=''select count(*) as cnt from '' || vTableName || '' where par_key= '' || rec.key;
		for rec2 in execute vSQL loop
			if rec2.cnt = 0 then
				vLeaf_flg:=''1'';
			else
				vLeaf_flg:=''0'';
			end if;
		end loop;

		vSQL:=''update '' || vTableName || '' set cust_level = '' || rec.level || '',leaf_flg = '' || vLeaf_flg || '' where key = ''|| rec.key;
		execute vSQL;
	end loop;

	return vSQL;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_money_1(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ''￥'' || ltrim(to_char(value,''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_money_1000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ''￥'' || ltrim(to_char((value/1000),''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_money_1000000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ''￥'' || ltrim(to_char((value/1000000),''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_camma_1(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char(value,''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_camma_1000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char((value/1000),''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_camma_1000000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char((value/1000000),''999,999,999,999,999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_no_format_1(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char(value,''999999999999999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_no_format_1000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char((value/1000),''999999999999999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_no_format_1000000(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char((value/1000000),''999999999999999''));
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/


CREATE OR REPLACE FUNCTION %schema%.oo_m_percent(NUMERIC) RETURNS VARCHAR AS '
DECLARE
    value ALIAS FOR $1;
    formatted_value VARCHAR;
BEGIN
    formatted_value := ltrim(to_char((value*100),''999999999999990D99'')) || ''%'';
    RETURN formatted_value;
END;
'LANGUAGE 'plpgsql';
/